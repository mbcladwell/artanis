<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-05-08 Tue 01:51 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GNU Artanis web-framework Manual</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Mu Lei known as NalaGinrut" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../css/manual.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">GNU Artanis web-framework Manual</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgead5652">1. Introduction</a>
<ul>
<li><a href="#orgb4e8529">1.1. Conventions used in this manual</a></li>
<li><a href="#org739fb97">1.2. No warranty</a></li>
</ul>
</li>
<li><a href="#orgce46c6c">2. License</a></li>
<li><a href="#orgd6cc40b">3. Installation</a>
<ul>
<li><a href="#orgbc71e6a">3.1. For users</a></li>
<li><a href="#org9935015">3.2. For contributors</a></li>
</ul>
</li>
<li><a href="#org1576e74">4. Configuration</a>
<ul>
<li><a href="#org9c7c6ad">4.1. Database config</a></li>
<li><a href="#orgc5d1455">4.2. Server config</a></li>
<li><a href="#org4cf8637">4.3. Websocket config</a></li>
<li><a href="#org9cf1957">4.4. Host config</a></li>
<li><a href="#orgbf8590d">4.5. Session config</a></li>
<li><a href="#orgdab7222">4.6. Upload config</a></li>
<li><a href="#org1f6208a">4.7. Cache config</a></li>
<li><a href="#orge41d4a1">4.8. Debug config</a></li>
<li><a href="#org6e92caa">4.9. Config APIs</a></li>
</ul>
</li>
<li><a href="#org6b1b007">5. Hello World</a>
<ul>
<li><a href="#org8e81791">5.1. Use Guile REPL and verify GNU Artanis installation</a></li>
<li><a href="#org482e9cf">5.2. Simple HTTP server</a></li>
<li><a href="#org2527edf">5.3. Try simple URL remappinge</a></li>
<li><a href="#org8545991">5.4. More complex URL remapping</a></li>
<li><a href="#org6202044">5.5. Regex in URL remapping</a></li>
<li><a href="#org662a4ba">5.6. Database operating</a></li>
</ul>
</li>
<li><a href="#org31f8225">6. Basic in Scheme</a>
<ul>
<li><a href="#orgfb759dc">6.1. For newbies</a></li>
<li><a href="#org7f1a275">6.2. For Pythonistas</a></li>
<li><a href="#orgc28aa0e">6.3. For Rubyist</a></li>
<li><a href="#org2468d1a">6.4. For deep learners</a></li>
</ul>
</li>
<li><a href="#orgecb83b8">7. Basic in GNU Artanis</a>
<ul>
<li><a href="#orgf89fa55">7.1. How to run a site with GNU Artanis</a></li>
<li><a href="#orgcc5deff">7.2. Initialization</a></li>
<li><a href="#orge342e86">7.3. Registering handler of HTTP methods</a></li>
<li><a href="#org5b6a522">7.4. Emit Response</a></li>
<li><a href="#orgcb632b9">7.5. Running server</a></li>
<li><a href="#orga4fb5d2">7.6. Working with Nginx</a></li>
</ul>
</li>
<li><a href="#orga7766cf">8. The Art command line</a>
<ul>
<li><a href="#org7292417">8.1. art create</a></li>
<li><a href="#orgb46ffe0">8.2. art draw</a></li>
<li><a href="#org73bc13d">8.3. art migrate</a></li>
<li><a href="#org0aa62c0">8.4. art work</a></li>
</ul>
</li>
<li><a href="#org303ffad">9. URL remapping</a>
<ul>
<li><a href="#org4b97be6">9.1. Introduction to URL remapping</a></li>
<li><a href="#orgc33255e">9.2. URL handling</a></li>
<li><a href="#org4fbc360">9.3. Get parameters from URL</a></li>
<li><a href="#orge567fbd">9.4. Redirect link</a></li>
</ul>
</li>
<li><a href="#org45c5efd">10. Route context</a>
<ul>
<li><a href="#org1945182">10.1. Route context APIs</a></li>
</ul>
</li>
<li><a href="#orga7a1ef4">11. MVC</a>
<ul>
<li><a href="#org4bad1b7">11.1. Controllers/Views</a></li>
<li><a href="#orga692f2c">11.2. Models</a></li>
</ul>
</li>
<li><a href="#orge2af7f5">12. Query String</a>
<ul>
<li><a href="#org719cf7c">12.1. Query string from GET</a></li>
<li><a href="#orgbd8bcac">12.2. Query string from POST</a></li>
</ul>
</li>
<li><a href="#orgcede7fa">13. Layouts and Rendering in GNU Artanis</a>
<ul>
<li><a href="#orgb3aa6c2">13.1. Templating</a></li>
<li><a href="#org92eec3e">13.2. Templating for Pythoners</a></li>
<li><a href="#orgbccbe9d">13.3. Templating for Rubyists</a></li>
<li><a href="#org90c19d2">13.4. Templating APIs</a></li>
<li><a href="#orgaf3562f">13.5. Embedded Templating</a></li>
<li><a href="#orgda5784a">13.6. Template special commands</a></li>
<li><a href="#org66925d6">13.7. SXML Templating</a></li>
</ul>
</li>
<li><a href="#org1952520">14. Database</a>
<ul>
<li><a href="#orgedc0190">14.1. DB connection pool</a></li>
<li><a href="#orgaec5f55">14.2. Migration</a></li>
<li><a href="#orga5be064">14.3. ORM problem</a></li>
<li><a href="#org9b11454">14.4. SSQL (experimental)</a></li>
<li><a href="#org06fa2ad">14.5. FPRM (experimental)</a>
<ul>
<li><a href="#org51d8e2d">14.5.1. Connect to DB server</a></li>
<li><a href="#org0c00fc5">14.5.2. Map DB table</a></li>
<li><a href="#org982516b">14.5.3. Create table</a></li>
<li><a href="#orga23b176">14.5.4. Get columns from table</a></li>
<li><a href="#orgd223865">14.5.5. Set values to table</a></li>
<li><a href="#org4cf87fb">14.5.6. Drop a table</a></li>
<li><a href="#org2085a5b">14.5.7. Check existence of table</a></li>
<li><a href="#org8a36b28">14.5.8. Get schema of a table</a></li>
</ul>
</li>
<li><a href="#org37320aa">14.6. SQL Mapping (experimental)</a></li>
</ul>
</li>
<li><a href="#org70ca296">15. MIME</a>
<ul>
<li><a href="#orgf3d8492">15.1. JSON</a></li>
<li><a href="#orgd598a85">15.2. CSV</a></li>
<li><a href="#orged08e0b">15.3. XML</a></li>
<li><a href="#orge7112ad">15.4. SXML</a></li>
</ul>
</li>
<li><a href="#orgbd49006">16. Upload files</a>
<ul>
<li><a href="#org24cd04c">16.1. Receive upload from client</a></li>
<li><a href="#orga3c4dee">16.2. Send upload to Server</a></li>
</ul>
</li>
<li><a href="#orgabf6258">17. Sessions</a></li>
<li><a href="#org12f08a2">18. Cookies</a></li>
<li><a href="#org1735623">19. Authentication</a>
<ul>
<li><a href="#org764199b">19.1. Init Authentication</a></li>
<li><a href="#orgb745449">19.2. Basic Authentication</a></li>
<li><a href="#orgfa16f8c">19.3. Common Authentication</a></li>
<li><a href="#org2f5b3bf">19.4. Login authentication</a></li>
<li><a href="#org52acb7c">19.5. HMAC</a></li>
</ul>
</li>
<li><a href="#org454de07">20. Cache</a>
<ul>
<li><a href="#orgd15ebd1">20.1. On web caching</a></li>
<li><a href="#org1cf95c0">20.2. Cache APIs</a></li>
</ul>
</li>
<li><a href="#orga5e3d57">21. Shortcuts</a>
<ul>
<li><a href="#org882ead7">21.1. What is shortcuts?</a></li>
<li><a href="#orgc9ac03c">21.2. Database connection</a></li>
<li><a href="#org8ebbf27">21.3. Raw SQL</a></li>
<li><a href="#orgd07d7f6">21.4. String template</a></li>
<li><a href="#org7e99e38">21.5. SQL-Mapping shortcut (unfinished)</a></li>
</ul>
</li>
<li><a href="#org891885a">22. Websocket (Experimental)</a>
<ul>
<li><a href="#org1ad2b21">22.1. Websocket introduction</a></li>
<li><a href="#org6afccd0">22.2. Websocket basic usage</a></li>
<li><a href="#org79eaaa6">22.3. Websocket APIs</a>
<ul>
<li><a href="#orga0b2ab4">22.3.1. Websocket configuration</a></li>
<li><a href="#org15fbd65">22.3.2. Websocket application</a></li>
</ul>
</li>
<li><a href="#orged071d9">22.4. Websocket frame</a></li>
<li><a href="#org51564f2">22.5. Websocket opcode</a></li>
</ul>
</li>
<li><a href="#org1db489b">23. Ragnarok server core</a>
<ul>
<li><a href="#orgdbe392e">23.1. Introduction</a></li>
<li><a href="#org599132f">23.2. Principles</a></li>
<li><a href="#orgedfa7c6">23.3. Features</a></li>
<li><a href="#orgcdf7a5b">23.4. Ragnarok APIs</a></li>
</ul>
</li>
<li><a href="#orgb1ef055">24. Utils</a>
<ul>
<li><a href="#org9f72388">24.1. String Template</a></li>
<li><a href="#org443e159">24.2. Random String Generator</a></li>
<li><a href="#orgf4f3048">24.3. Cryptographic hash functions</a></li>
<li><a href="#orga55b1ba">24.4. Stack &amp; Queue</a></li>
<li><a href="#org17ce025">24.5. Useful string operation</a></li>
<li><a href="#orga995ead">24.6. Time operation tool</a></li>
</ul>
</li>
<li><a href="#org455fc5a">25. Debug mode</a></li>
<li><a href="#orgec8aa3f">26. Appendix A GNU Free Documentation License</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgead5652" class="outline-2">
<h2 id="orgead5652"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-nil">Copyright (C)  2017  Mu Lei known as NalaGinrut.
Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
Texts.  A copy of the license is included in the section entitled 'GNU
Free Documentation License'.
</pre>
</div>

<p>
This manual documents GNU Artanis, a fast, monolithithic web framework of Scheme.
</p>

<p>
A <a href="http://en.wikipedia.org/wiki/Web_application_framework">web application framework (WAF)</a> is a software framework that is designed to support the development of dynamic websites,
web applications, web services and web resources.
This framework aims to alleviate the overhead associated with common activities in web development.
GNU Artanis provides several tools for web development: database access, templating frameworks, session management, <a href="http://en.wikipedia.org/wiki/Rewrite_engine">URL-remapping</a> for <a href="http://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a>, page caching, and more.
</p>

<p>
Guile is the GNU Ubiquitous Intelligent Language for Extensions, the official extension language for the <a href="http://www.gnu.org/">GNU operating system</a>.
Guile is also an interpreter and compiler for other dynamic programming languages including Scheme.
</p>

<p>
<a href="http://en.wikipedia.org/wiki/Scheme_(programming_language)">Scheme</a> is a functional programming language and one of the two main dialects of the programming language <a href="http://en.wikipedia.org/wiki/Lisp_(programming_language)">Lisp</a>.
Scheme follows a minimalist design philosophy specifying a small standard core with powerful tools for language extension.
</p>
</div>
<div id="outline-container-orgb4e8529" class="outline-3">
<h3 id="orgb4e8529"><span class="section-number-3">1.1</span> Conventions used in this manual</h3>
<div class="outline-text-3" id="text-1-1">
<p>
In this manual the following syntax is used to demonstrate the use of the API:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(api-name arg1 arg2 <span style="color: #40e0d0;">#:key0</span> val0 ... [optional-arg1 &lt;- default-value1] ...)
</pre>
</div>
<p>
If you are new to Scheme, it is recommended that you read the <a href="#org31f8225">Basic in Scheme</a> chapter first.
</p>
</div>
</div>
<div id="outline-container-org739fb97" class="outline-3">
<h3 id="org739fb97"><span class="section-number-3">1.2</span> No warranty</h3>
<div class="outline-text-3" id="text-1-2">
<p>
We distribute software in the hope that it will be useful, but without any warranty. No author or distributor of this software accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless they say so in writing. This is exactly the same warranty that proprietary software companies offer: none.
</p>
</div>
</div>
</div>
<div id="outline-container-orgce46c6c" class="outline-2">
<h2 id="orgce46c6c"><span class="section-number-2">2</span> License</h2>
<div class="outline-text-2" id="text-2">
<p>
GNU Artanis is <a href="http://www.gnu.org/philosophy/free-sw.html">Free Software</a>. GNU Artanis is under the terms of the GNU GPLv3+ and GNU LGPLv3+.
See the files COPYING and COPYING.LESSER in toplevel of source code.
</p>

<p>
This manual is published under the terms of the <a href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License</a> 1.3 or later.
</p>

<p>
<b>You must be aware there is no warranty whatsoever for GNU Artanis. This is described in full in the
This is described in full in the licenses.</b>
</p>
</div>
</div>
<div id="outline-container-orgd6cc40b" class="outline-2">
<h2 id="orgd6cc40b"><span class="section-number-2">3</span> Installation</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-orgbc71e6a" class="outline-3">
<h3 id="orgbc71e6a"><span class="section-number-3">3.1</span> For users</h3>
<div class="outline-text-3" id="text-3-1">
<p>
<b>Install GNU Guile-2.2.2 or higher version:</b>
</p>

<p>
Since GNU Artanis-0.2, the GNU Guile-2.2+ is required because of the <a href="https://www.gnu.org/software/guile/manual/html_node/Non_002dBlocking-I_002fO.html">suspendable-ports</a>, which is the key to implement asynchronous
non-blocking server core in GNU Guile.
</p>

<div class="org-src-container">
<pre class="src src-null">wget -c ftp://ftp.gnu.org/gnu/guile/guile-2.2.2.tar.xz
tar xvf guile-2.2.2.tar.xz
cd guile-2.2.2 &amp;&amp; ./configure &amp;&amp; make #(NOTE: this may take very long time even looks like halting)
sudo make install
</pre>
</div>

<p>
I would NOT recommend you trying to compile/install Guile from Git repo, since it'll take too much time of you.
</p>

<p>
<b>Install dependencies:</b>
</p>

<ul class="org-ul">
<li>guile-dbi-2.1.6 <b>[Optional]</b></li>
</ul>
<div class="org-src-container">
<pre class="src src-null">wget -c http://download.gna.org/guile-dbi/guile-dbi-2.1.6.tar.gz
# or mirror
wget -c https://github.com/yagelix/guile-dbi/archive/guile-dbi-2.1.6.tar.gz

tar xvzf guile-dbi-2.1.6.tar.gz
cd guile-dbi-2.1.6 &amp;&amp; ./configure &amp;&amp; make
sudo make install
</pre>
</div>

<ul class="org-ul">
<li>guile-dbd <b>[Optional]</b>. The dbd plugins connect to an actual database server.</li>
</ul>
<div class="org-src-container">
<pre class="src src-null">wget -c http://download.gna.org/guile-dbi/guile-dbd-mysql-2.1.6.tar.gz
# or mirror
wget -c https://github.com/yagelix/guile-dbi/archive/guile-dbd-mysql-2.1.6.tar.gz

tar xvzf guile-dbd-mysql-2.1.6.tar.gz
cd guile-dbd-mysql-2.1.6 &amp;&amp; ./configure &amp;&amp; make
sudo make install
</pre>
</div>
<p>
MySQL is used for the examples in this manual. You may find dbd plugins for other databases at <a href="http://download.gna.org/guile-dbi">here</a> or
<a href="https://github.com/yagelix/guile-dbi/releases">mirror</a>. The installation process is identical.
</p>

<p>
<b>Install the latest GNU Artanis:</b>
</p>

<div class="org-src-container">
<pre class="src src-null">wget -c http://ftp.gnu.org/gnu/artanis/artanis-latest.tar.bz2
tar xvjf artanis-latest.tar.bz2
cd artanis-latest &amp;&amp; ./configure &amp;&amp; make
sudo make install
</pre>
</div>
</div>
</div>

<div id="outline-container-org9935015" class="outline-3">
<h3 id="org9935015"><span class="section-number-3">3.2</span> For contributors</h3>
<div class="outline-text-3" id="text-3-2">
<p>
First of all, thank you for contributing! You may clone the main git repository, or the mirror on GitLab:
</p>

<div class="org-src-container">
<pre class="src src-null">git clone git://git.savannah.gnu.org/artanis.git

# mirror on GitLab
git clone https://gitlab.com/NalaGinrut/artanis.git
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1576e74" class="outline-2">
<h2 id="org1576e74"><span class="section-number-2">4</span> Configuration</h2>
<div class="outline-text-2" id="text-4">
<p>
A configuration file is required when Artanis is run for the first time.
</p>

<ul class="org-ul">
<li>If you're using minimum mode, say, all code are in a script file without application folder.
The configure file must be named <code class="src src-conf">/etc/artanis/artanis.conf</code>.</li>

<li>If you're using application folder, the configure file <code class="src src-conf">conf/artanis.conf</code> will be generated automatically for you.</li>
</ul>
</div>
<div id="outline-container-org9c7c6ad" class="outline-3">
<h3 id="org9c7c6ad"><span class="section-number-3">4.1</span> Database config</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.enable</span> = &lt;boolean&gt;
</pre>
</div>
<ul class="org-ul">
<li>Whether to use database, if disabled, the database won't be initialized in the beginning, which saves memory and boot time.
<ul class="org-ul">
<li>Some users may want to use GNU Artanis without configuring any databases, so please set it to <b>false</b> to avoid error.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.dbd</span> = mysql | postgresql | sqlite3
</pre>
</div>
<ul class="org-ul">
<li>What database server should be used, depends on the database installed on your machine.
<ul class="org-ul">
<li>NOTE: If you use MariaDB then you should set it to mysql as well.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.proto</span> = tcp | socketfile
</pre>
</div>
<ul class="org-ul">
<li>The protocol for connecting the databse. If you use tcp then a socket port must be specified in the address, and if you choose socketfile,
then you should specify the unix socket file which has been configured by the databases.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.addr</span> = &lt;string&gt;
</pre>
</div>
<ul class="org-ul">
<li>The address of the database server, for example, in default MariaDB, the address should be <b><i>localhost:3306</i></b>.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.socketfile</span> = &lt;string&gt;
</pre>
</div>
<ul class="org-ul">
<li>If you configured the database server to be connected with an unix socket file, then you should fill this field with the file name.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.username</span> = &lt;string&gt;
</pre>
</div>
<ul class="org-ul">
<li>User name of the database server.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.passwd</span> = &lt;string&gt;
</pre>
</div>
<ul class="org-ul">
<li>Password of the database server.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.name</span> = &lt;string&gt;
</pre>
</div>
<ul class="org-ul">
<li>The database name of the database server.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">db.engine</span> = &lt;string&gt;
</pre>
</div>
<ul class="org-ul">
<li>The engine of the database server.
<ul class="org-ul">
<li><b><i>NOTE:</i></b> for sqlite3, you have to set it to nothing, say <code class="src src-conf">db.engine = </code>. If you remove this item at all, it'll be <b><i>InnoDB</i></b> in default!</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgc5d1455" class="outline-3">
<h3 id="orgc5d1455"><span class="section-number-3">4.2</span> Server config</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.info</span> = &lt;string&gt;
</pre>
</div>
<ul class="org-ul">
<li>Specify your own server info, it'll be /*Artanis-x.x.x/* in default, depends on the version.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.nginx</span> = enable | disable
</pre>
</div>
<ul class="org-ul">
<li>If you used Nginx as the reversed-proxy, please enable it.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.charset</span> = &lt;string&gt;
</pre>
</div>
<ul class="org-ul">
<li>Charset in server side. <i><b>utf-8</b></i> in default.
<ul class="org-ul">
<li><i><b>Note:</b></i> Don't change it unless you know what you're doing!</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.syspage.path</span> = /etc/artanis/pages
</pre>
</div>
<ul class="org-ul">
<li>The path of status page. You may customize your own status pages.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.backlog</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>Backlog of the socket.
<ul class="org-ul">
<li><i><b>Note:</b></i> Don't change it unless you really know what you're doing!</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.wqlen</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>The length of the work queue in Artanis server.
<ul class="org-ul">
<li><i><b>Note:</b></i> Added since Artanis-0.2.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.trigger</span> = edge | level
</pre>
</div>
<ul class="org-ul">
<li>The trigger mode of epoll.
<ul class="org-ul">
<li><i><b>Note:</b></i> Added since Artanis-0.2.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.engine</span> = ragnarok | guile | fibers | &lt;customized engine&gt;
</pre>
</div>
<ul class="org-ul">
<li>The server core which is used for holding high concurrent connections. Artanis has a strong server core named <a href="#org1db489b">Ragnarok,</a>
which is based on <a href="https://en.wikipedia.org/wiki/Delimited_continuation">delimited continuations</a> to provide asynchronous non-blocking high concurrent serving.
<ul class="org-ul">
<li>You may choose guile inner server which is weak, but sometimes you may under an operating system lacking of key features
to run Raganrok, for example, maybe there's no epoll in your Operating System, for example, GNU/Hurd.</li>
<li>You may choose fibers server implemented with threads and delimited continuations, which is preemptable by the timer you set.
For more details please see <a href="https://github.com/wingo/fibers/wiki/Manual">Fiber Manual</a>.</li>
<li><i><b>Note:</b></i> Added since Artanis-0.2.</li>
<li><i><b>Note:</b></i> Fibers is supported since Artanis-0.2.5.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.polltimeout</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>The the timeout for each event polling round, in miliseconds.
<ul class="org-ul">
<li>The default value is 500 miliseconds.</li>
<li><i><b>Note:</b></i> Added since Artanis-0.2.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.bufsize</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>The buffer size of the connecting socket. In <a href="#org1db489b">Ragnarok</a>, the request handling will be scheduled when the
socket buffer is full. This item effects the performance of socket I/O largely. Usually, if you're handling
massive small requests, it's better to set the buffer size small; but if you're providing kind of downloading
or uploading service, it's better to set it larger. But the large buffer size will increase the latency of
unserved requests. Please read <a href="#org1db489b">Ragnarok</a> chapter to learn the design principle, which will be helpful for you
to decide how to tweak.
<ul class="org-ul">
<li>The default value is 12288, say, 12KB.</li>
<li><i><b>Note:</b></i> Added since Artanis-0.2.</li>
</ul></li>
</ul>


<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">server.multi</span> = &lt;boolean&gt;
</pre>
</div>
<ul class="org-ul">
<li>This is the most significant feature of <a href="#org1db489b">Ragnarok</a>. Please remember that <b>there's no any thread in GNU Artanis</b>.
All the tasks are based on <a href="https://en.wikipedia.org/wiki/Delimited_continuation">delimited continuations</a>, this kind of design is the so-called <a href="https://en.wikipedia.org/wiki/Green_threads">Green Threads.</a>
Then how to take advantage of multi-cores? Fortunately, GNU/Linux has introduced a feature named <a href="https://lwn.net/Articles/542629/">SO_REUSEPORT</a> since 3.9.
This feature let us start multiple Artanis instances listenning on the same socket port. When requests come, the
Linux kernel will do necessary lock and allocation work for us to dispatch requests to these Artanis instances.
This makes GNU Artanis provide performance and stateless perfectly.
<ul class="org-ul">
<li>The default value is true.</li>
<li><i><b>Note:</b></i> Added since Artanis-0.2, GNU/Linux-3.9+ is required.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org4cf8637" class="outline-3">
<h3 id="org4cf8637"><span class="section-number-3">4.3</span> Websocket config</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">websocket.maxpayload</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>The max payload size in bytes.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">websocket.minpayload</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>The min payload size in bytes.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">websocket.minpayload</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>The min payload size in bytes.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">websocket.fragment</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>If <i>fragment</i> is larger than zero, then it's the size of websocket frame fragment.</li>
<li>If <i>fragment</i> is zero, then the websocket frame will not be fragmented.</li>
</ul>
</div>
</div>

<div id="outline-container-org9cf1957" class="outline-3">
<h3 id="org9cf1957"><span class="section-number-3">4.4</span> Host config</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">host.name</span> = enable | disable | &lt;boolean&gt;
</pre>
</div>
<ul class="org-ul">
<li>If disabled, you have to set the address to IP, say, <code class="src src-conf">host.addr = 127.0.0.1</code>.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">host.addr</span> = &lt;URL&gt; | &lt;IP&gt;
</pre>
</div>
<ul class="org-ul">
<li>The host address of the site.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">host.port</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>The listenning port of your hosting site.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">host.family</span> = ipv4 | ipv6
</pre>
</div>
<ul class="org-ul">
<li>Specify the protocol family
<ul class="org-ul">
<li>Added since Artanis-0.2.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgbf8590d" class="outline-3">
<h3 id="orgbf8590d"><span class="section-number-3">4.5</span> Session config</h3>
<div class="outline-text-3" id="text-4-5">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">session.path</span> = &lt;PATH&gt;
</pre>
</div>
<ul class="org-ul">
<li>Specify the session files path. It depends on the session engine.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">session.engine</span> = simple | db | file | &lt;third-party-engine&gt;
</pre>
</div>
<ul class="org-ul">
<li>Specify session engine.
<ul class="org-ul">
<li><b>simple</b> uses hash table for memcache.</li>
<li><b>db</b> uses RDBMS for storing sessions.</li>
<li><b>file</b> stores session information into text files.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgdab7222" class="outline-3">
<h3 id="orgdab7222"><span class="section-number-3">4.6</span> Upload config</h3>
<div class="outline-text-3" id="text-4-6">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">upload.types</span> = &lt;item-list&gt;
</pre>
</div>
<ul class="org-ul">
<li>Specify allowed upload file type, say, <code class="src src-conf">upload.types = jpg,png,gif</code>.
<ul class="org-ul">
<li><i><b>Note:</b></i> Added since Artanis-0.2.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">upload.path</span> = &lt;PATH&gt;
</pre>
</div>
<ul class="org-ul">
<li>The path to put the uploaded files.</li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">upload.size</span> = &lt;interger&gt;
</pre>
</div>
<ul class="org-ul">
<li>The size limitation of uploaded file in bytes.
<ul class="org-ul">
<li><i><b>Note:</b></i> Added since Artanis-0.2</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org1f6208a" class="outline-3">
<h3 id="org1f6208a"><span class="section-number-3">4.7</span> Cache config</h3>
<div class="outline-text-3" id="text-4-7">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">cache.maxage</span> = &lt;integer&gt;
</pre>
</div>
<ul class="org-ul">
<li>The maximum age of cached page in seconds.
<ul class="org-ul">
<li>This is the global maxage of any cache. If you want to specify maxage for certain page, please read <a href="#org454de07">Cache</a>.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orge41d4a1" class="outline-3">
<h3 id="orge41d4a1"><span class="section-number-3">4.8</span> Debug config</h3>
<div class="outline-text-3" id="text-4-8">
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">debug.enable</span> = &lt;boolean&gt;
</pre>
</div>
<ul class="org-ul">
<li>Wheather to enable debug mode. If you enable debug mode, Artanis will print debug information verbosely.
The module you modified will be reloaded instantly, and the page view will be rendered either.</li>
<li><i>NOTE: This option will drag the performance of Artanis, so please use it for debug only.</i></li>
</ul>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">debug.monitor</span> = &lt;PATHs&gt;
</pre>
</div>
<ul class="org-ul">
<li>The paths need to be monitored in debug-mode. This will take advantage of `inotify' in GNU/Linux kernel.
<ul class="org-ul">
<li><i><b>Note:</b></i> We may support GNU/Hurd as well, with its file monitor mechanism, in the future.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6e92caa" class="outline-3">
<h3 id="org6e92caa"><span class="section-number-3">4.9</span> Config APIs</h3>
<div class="outline-text-3" id="text-4-9">
<p>
To change the default configurations:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(conf-set! key value)
<span style="color: #66cdaa;">;;</span><span style="color: #66cdaa;">e.g</span>
(conf-set! 'debug-mode #t)
</pre>
</div>

<p>
To get the current configre
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get-conf key)
<span style="color: #66cdaa;">;;</span><span style="color: #66cdaa;">e.g</span>
(get-conf '(server charset))
</pre>
</div>

<p>
To get current hostname in GNU Artanis environment.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(current-myhost)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org6b1b007" class="outline-2">
<h2 id="org6b1b007"><span class="section-number-2">5</span> Hello World</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-org8e81791" class="outline-3">
<h3 id="org8e81791"><span class="section-number-3">5.1</span> Use Guile REPL and verify GNU Artanis installation</h3>
<div class="outline-text-3" id="text-5-1">
<p>
If you are already familiar with Guile, you may skip this section.
</p>

<p>
Type `guile' in your console to enter the Guile REPL. You should see the following text displayed on your screen:
</p>
<div class="org-src-container">
<pre class="src src-null">GNU Guile 2.2.2
Copyright (C) 1995-2017 Free Software Foundation, Inc.

Guile comes with ABSOLUTELY NO WARRANTY; for details type `,show w'.
This program is free software, and you are welcome to redistribute it
under certain conditions; type `,show c' for details.

Enter `,help' for help.
scheme@(guile-user)&gt;
</pre>
</div>

<p>
Welcome to Guile world! We are now going to play with GNU Artanis. Before we start, we need to check that GNU Artanis is installed correctly:
</p>

<p>
<b>(Just type them, you don't have to understand them at present)</b>
</p>

<div class="org-src-container">
<pre class="src src-scheme">,use (artanis artanis)
artanis-version
</pre>
</div>

<p>
The expected output should be similar to this:
</p>
<div class="org-src-container">
<pre class="src src-scheme">$1 = <span style="color: #ff0000;">"GNU Artanis-x.x.x"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org482e9cf" class="outline-3">
<h3 id="org482e9cf"><span class="section-number-3">5.2</span> Simple HTTP server</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Run this code in your console:
</p>
<div class="org-src-container">
<pre class="src src-bash">guile -c <span style="color: #ff0000;">"(use-modules (artanis artanis))(init-server)(run)"</span>
<span style="color: #66cdaa;">## </span><span style="color: #66cdaa;">You'll see this screen:</span>
Anytime you want to quit just try Ctrl+C, thanks!
http://127.0.0.1:3000
</pre>
</div>

<p>
Assuming there's a file named "index.html" in the current path. Now you may try <a href="http://localhost:3000/index.html">http://localhost:3000/index.html</a> in your browser.
It's just simply fetching static file by the URL: <a href="http://localhost:3000/path/filename">http://localhost:3000/path/filename</a>
</p>
</div>
</div>
<div id="outline-container-org2527edf" class="outline-3">
<h3 id="org2527edf"><span class="section-number-3">5.3</span> Try simple URL remappinge</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Type these code in Guile REPL:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">use-modules</span> (artanis artanis))
(get <span style="color: #ff0000;">"/hello"</span> (<span style="color: #4169e1;">lambda</span> () <span style="color: #ff0000;">"hello world"</span>))
(run <span style="color: #40e0d0;">#:port</span> 8080)
</pre>
</div>

<p>
Now you can visit <a href="http://localhost:8080/hello">http://localhost:8080/hello</a> with your browser, and (hopefully) see the result.
</p>

<p>
<i>If you encounter "[EXCEPTION] /favicon.ico is abnormal request" , please just ignore that warning.</i>
</p>

<p>
Let me explain the code:
</p>

<ul class="org-ul">
<li><i>line 1:</i> Load GNU Artanis module, (artanis artanis) is the name.</li>
</ul>


<ul class="org-ul">
<li><i>line 2:</i> The first argument <i>get</i> is GNU Artanis' API correspondence to the GET method of the HTTP protocol.
The second argument "/hello" is the URL rule to register showing in the address line of e.g. firefox.
The third argument is the handler which will be triggered if the registered URL rule is hit.</li>

<li><i>line 3:</i> Run the GNU Artanis web server, and listen on socket port 8080.</li>
</ul>

<p>
You may type Ctrl+C to quit and stop the server, see also the message printed on the screen accordingly.
</p>
</div>
</div>
<div id="outline-container-org8545991" class="outline-3">
<h3 id="org8545991"><span class="section-number-3">5.4</span> More complex URL remapping</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Try this code:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">use-modules</span> (artanis artanis))
(init-server)
(get <span style="color: #ff0000;">"/hello/:who"</span>
  (<span style="color: #4169e1;">lambda</span> (rc)
    (format #f <span style="color: #ff0000;">"&lt;p&gt;hello ~a&lt;/p&gt; "</span> (params rc <span style="color: #ff0000;">"who"</span>))))
(run <span style="color: #40e0d0;">#:port</span> 8080)
</pre>
</div>

<p>
Now you can try <a href="http://localhost:8080/hello/artanis">http://localhost:8080/hello/artanis</a> in your browser.
</p>

<p>
There are two differences:
</p>
<ul class="org-ul">
<li>1. The special rule, "<code>/hello/:who</code>", <i>:who</i> means you can use <i>params</i> to reference the value of this section of URL with the key "who". <code class="src src-scheme">(params rc "who")</code> is the way for that.</li>

<li>2. You may have noticed that the handler is being defined as an anonymous function with <i>lambda</i> has one argument <i>rc</i>. It means <i>route context</i> which preserves all the related context information. Many GNU Artanis APIs need it, e.g.  <i>params</i>.</li>
</ul>

<p>
And <i>format</i> is a Scheme lib function. It is similar to <i>sprintf</i> in the C language, which outputs text with a formatted pattern.
The second argument #f (means FALSE) indicates that returning the result as string type rather than printing out.
</p>
</div>
</div>
<div id="outline-container-org6202044" class="outline-3">
<h3 id="org6202044"><span class="section-number-3">5.5</span> Regex in URL remapping</h3>
<div class="outline-text-3" id="text-5-5">
<p>
You can use regex in the URL rule.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">use-modules</span> (artanis artanis))
(init-server)
(get <span style="color: #ff0000;">"/.+\\.(png|gif|jpeg)"</span> static-page-emitter)
(run <span style="color: #40e0d0;">#:port</span> 8080)
</pre>
</div>

<p>
<i>static-page-emitter</i> is an GNU Artanis API which emits a static file (images, data files) to the client.
</p>
</div>
</div>
<div id="outline-container-org662a4ba" class="outline-3">
<h3 id="org662a4ba"><span class="section-number-3">5.6</span> Database operating</h3>
<div class="outline-text-3" id="text-5-6">
<p>
GNU Artanis supports mysql/postgresql/sqlite3, we use mysql as a example here.
</p>

<p>
Please ensure that your DB service was started before you try.
</p>

<p>
<b><i>If you encounter any problems, please check your config of DB first.</i></b>
</p>

<p>
You can use a DB (such as mysql) with GUI tools such as "adminer" prior and independent of running an web-server, e.g. artanis-based.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">use-modules</span> (artanis artanis))
(init-server)
(<span style="color: #4169e1;">define</span> <span style="color: #ffd700;">conn</span> (connect-db 'mysql <span style="color: #40e0d0;">#:db-username</span> <span style="color: #ff0000;">"your_db_username"</span>
                         <span style="color: #40e0d0;">#:db-name</span> <span style="color: #ff0000;">"your_db_name"</span> <span style="color: #40e0d0;">#:db-passwd</span> <span style="color: #ff0000;">"your_passwd"</span>))
(<span style="color: #4169e1;">define</span> <span style="color: #ffd700;">mtable</span> (map-table-from-DB conn))
((mtable 'create 'Persons '((name varchar 10)
                            (age integer)
                            (email varchar 20)))
 'valid?)
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">==&gt; #t</span>
(mtable 'set 'Persons <span style="color: #40e0d0;">#:name</span> <span style="color: #ff0000;">"nala"</span> <span style="color: #40e0d0;">#:age</span> 99 <span style="color: #40e0d0;">#:email</span> <span style="color: #ff0000;">"nala@artanis.com"</span>)
(mtable 'get 'Persons <span style="color: #40e0d0;">#:columns</span> '(name email))
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">==&gt; ((("name" . "nala") ("email" . "nala@artanis.com")))</span>
</pre>
</div>

<ul class="org-ul">
<li><i>map-table-from-DB</i> is GNU Artanis API handling tables in DB. Here, we define this mapping as the var <i>mtable</i>.</li>
</ul>


<ul class="org-ul">
<li>And we can use <i>mtable</i> to handle tables, you can get values from table with 'get command.</li>
</ul>


<ul class="org-ul">
<li><i>mtable</i> is a function which accepts the first argument as a command, say 'create is a command to create a new table; 'set command is used to insert/update the table; 'get command for fetch the values of specified columns.</li>
</ul>


<ul class="org-ul">
<li>The second argument of <i>mtable</i> is the name of the table as you guess. Please note that it is case sensitive. But the column name could be case insensitive.</li>
</ul>


<ul class="org-ul">
<li><i><b>'create</b></i> command returns a function too, which also accepts an argument as a command. Here, we use <i><b>'valid?</b></i> command to check if the table has been created successfully.</li>
</ul>

<p>
Here's just simple introduction. You may read the DB section in this manual for detail describing.
</p>

<p>
Of course, you can use DB in your web application.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/dbtest"</span> <span style="color: #40e0d0;">#:conn</span> #t <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">apply for a DB connection from pool</span>
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #4169e1;">let</span> ((mtable (map-table-from-DB (<span style="color: #40e0d0;">:conn</span> rc))))
         (object-&gt;string
          (mtable 'get 'Persons <span style="color: #40e0d0;">#:columns</span> '(name email))))))

(run <span style="color: #40e0d0;">#:use-db?</span> #t <span style="color: #40e0d0;">#:dbd</span> 'mysql <span style="color: #40e0d0;">#:db-username</span> <span style="color: #ff0000;">"your_db_username"</span>
     <span style="color: #40e0d0;">#:db-name</span> <span style="color: #ff0000;">"your_db_name"</span> <span style="color: #40e0d0;">#:db-passwd</span> <span style="color: #ff0000;">"your_passwd"</span> <span style="color: #40e0d0;">#:port</span> 8080)
</pre>
</div>

<p>
Now, try loading <a href="http://localhost:8080/dbtest">http://localhost:8080/dbtest</a> in your browser.
</p>

<p>
Here are some explanations:
</p>
<ul class="org-ul">
<li>The keyword-value pair <code class="src src-scheme">#:conn #t</code> means applying for a DB connection from connection-pool.
Then you can use <code class="src src-scheme">(:conn rc)</code> to get the allocated connection for DB operations.</li>

<li>Finally, the handler needs to return a string as the HTTP response body, so we have to use Guile API <i>object-&gt;string</i> to
convert the query result to string, for this naive example case.</li>
</ul>

<p>
<i>Exercise: Return a beautiful table in HTML rather than using object-&gt;string.</i>
</p>
</div>
</div>
</div>
<div id="outline-container-org31f8225" class="outline-2">
<h2 id="org31f8225"><span class="section-number-2">6</span> Basic in Scheme</h2>
<div class="outline-text-2" id="text-6">
<p>
This chapter introduces some useful documents to help you understand Scheme language well.
Feel free to come back here if you have any problem with Scheme syntax.
</p>

<p>
If expedient, read the section repeatedly.
</p>

<p>
Scheme was introduced in 1975 by Gerald J. Sussman and Guy L. Steele Jr. and was the first dialect of Lisp to fully support lexical scoping,
first-class procedures, and continuations. In its earliest form it was a small language intended primarily for research and teaching,
supporting only a handful of predefined syntactic forms and procedures. Scheme is now a complete general-purpose programming language, though
it still derives its power from a small set of key concepts. Early implementations of the language were interpreter-based and slow, but
Guile Scheme is trying to implement sophisticated compiler that generate better optimized code, and even a plan for AOT compiler generated
native code in the future.
</p>
</div>

<div id="outline-container-orgfb759dc" class="outline-3">
<h3 id="orgfb759dc"><span class="section-number-3">6.1</span> For newbies</h3>
<div class="outline-text-3" id="text-6-1">
<p>
If you're not familiar with Scheme and Guile in particular, here is a simple tutorial for you.
</p>

<p>
If you already know the basics of the Scheme language, please feel free to skip this section.
</p>

<p>
I would recommend newbies to type/paste the code in Guile REPL following the guide in tutorial:
<a href="http://web-artanis.com/scheme.html">Learn Scheme in 15 minutes</a>
</p>

<p>
And here's a nice section in Guile manual for basics in Scheme:
<a href="https://www.gnu.org/software/guile/manual/guile.html#Hello-Scheme_0021">Hello Scheme</a>
</p>

<p>
Please don't spend too much time on these tutorials, the purpose is to let newbies get a little familiar with the grammar of Scheme.
</p>
</div>
</div>

<div id="outline-container-org7f1a275" class="outline-3">
<h3 id="org7f1a275"><span class="section-number-3">6.2</span> For Pythonistas</h3>
<div class="outline-text-3" id="text-6-2">
<p>
These are good pythonic articles for Pythoners:
</p>

<ol class="org-ol">
<li><a href="http://draketo.de/proj/guile-basics/">Guile basics from the perspective of a Pythonista</a></li>
<li><a href="http://draketo.de/proj/py2guile">Going from Python to Guile Scheme</a></li>
</ol>

<p>
Still, please don't spend too much time on them, the purpose is to let newbies get a little familiar with the grammar of Scheme.
</p>
</div>
</div>

<div id="outline-container-orgc28aa0e" class="outline-3">
<h3 id="orgc28aa0e"><span class="section-number-3">6.3</span> For Rubyist</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Here's a great article for Rubyist to learn Scheme:
</p>
<ol class="org-ol">
<li><a href="http://wiki.call-cc.org/chicken-for-ruby-programmers">Scheme for ruby programmers</a></li>
</ol>
</div>
</div>
<div id="outline-container-org2468d1a" class="outline-3">
<h3 id="org2468d1a"><span class="section-number-3">6.4</span> For deep learners</h3>
<div class="outline-text-3" id="text-6-4">
<p>
These two books are very good for learning Scheme seriously:
</p>

<ol class="org-ol">
<li><a href="http://www.scheme.com/tspl4/">The Scheme Programming Language</a></li>
<li><a href="http://mitpress.mit.edu/sicp/">Structure and Interpretation of Computer Programs(SICP)</a></li>
</ol>

<p>
Please don't bother reading them if you simply want to use GNU Artanis to build your web application/site in few minutes.
</p>

<p>
And if you really want to try to work these books seriously, please ignore GNU Artanis before you are done with them.
</p>

<p>
But once you're done reading them <b>carefully</b>, you may want to write a new GNU Artanis all by yourself!
</p>

<p>
Hold your horses. ;-)
</p>
</div>
</div>
</div>
<div id="outline-container-orgecb83b8" class="outline-2">
<h2 id="orgecb83b8"><span class="section-number-2">7</span> Basic in GNU Artanis</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-orgf89fa55" class="outline-3">
<h3 id="orgf89fa55"><span class="section-number-3">7.1</span> How to run a site with GNU Artanis</h3>
<div class="outline-text-3" id="text-7-1">
<p>
This is the simplest case to run a site:
</p>
<div class="org-src-container">
<pre class="src src-scheme">#!/bin/env guile
!#
(<span style="color: #4169e1;">use-modules</span> (artanis artanis))
(init-server)
(get <span style="color: #ff0000;">"/hello"</span> (<span style="color: #4169e1;">lambda</span> () <span style="color: #ff0000;">"hello world"</span>))
(run)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcc5deff" class="outline-3">
<h3 id="orgcc5deff"><span class="section-number-3">7.2</span> Initialization</h3>
<div class="outline-text-3" id="text-7-2">
<p>
It's better to use (init-server) to init GNU Artanis.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(init-server <span style="color: #40e0d0;">#:statics</span> '(png jpg jpeg ico html js css)
             <span style="color: #40e0d0;">#:cache-statics?</span> #f <span style="color: #40e0d0;">#:exclude</span> '())
</pre>
</div>

<p>
<code class="src src-scheme">#:statics</code> specifies the static files with the extension file. GNU Artanis is based on URL remapping, so this keyword let you avoid to handle each static file types. In default, it covers the most static file types. So you may ignore it usually.
</p>

<p>
<code class="src src-scheme">#:cache-statics?</code> indicates if the static files should be cached.
</p>

<p>
<code class="src src-scheme">#:exclude</code> specifies the types should be excluded. This is useful when you want to generate image files dynamically. Even JavaScript/CSS could be generated dynamically, depends your design.
</p>
</div>
</div>
<div id="outline-container-orge342e86" class="outline-3">
<h3 id="orge342e86"><span class="section-number-3">7.3</span> Registering handler of HTTP methods</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Please read <a href="#orgc33255e">URL handling</a>.
</p>
</div>
</div>
<div id="outline-container-org5b6a522" class="outline-3">
<h3 id="org5b6a522"><span class="section-number-3">7.4</span> Emit Response</h3>
<div class="outline-text-3" id="text-7-4">
<div class="org-src-container">
<pre class="src src-scheme">(response-emit body <span style="color: #40e0d0;">#:status</span> 200 <span style="color: #40e0d0;">#:headers</span> '() <span style="color: #40e0d0;">#:mtime</span> (current-time))
</pre>
</div>

<p>
<b>body</b> is the response body, it can be bytevector or literal string (in HTML).
</p>

<p>
<code class="src src-scheme">#:status</code> is HTTP status, 200 in default, which means OK.
</p>

<p>
<code class="src src-scheme">#:headers</code> let you specify customized HTTP headers. The headers must follow certain format, you have to read about the <a href="http://www.gnu.org/software/guile/manual/html_node/HTTP-Headers.html#Response-Headers">Response Headers</a>.
</p>

<p>
<code class="src src-scheme">#:mtime</code> specifies the modify time in the response. GNU Artanis will generate it for you if you just ignore it.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(emit-response-with-file filename [headers &lt;- '()])
</pre>
</div>

<p>
<b>filename</b> is the filename to be sent as a response.
</p>

<p>
[headers] is the customized HTTP headers.
</p>
</div>
</div>

<div id="outline-container-orgcb632b9" class="outline-3">
<h3 id="orgcb632b9"><span class="section-number-3">7.5</span> Running server</h3>
<div class="outline-text-3" id="text-7-5">
<div class="org-src-container">
<pre class="src src-scheme">(run <span style="color: #40e0d0;">#:host</span> #f <span style="color: #40e0d0;">#:port</span> #f <span style="color: #40e0d0;">#:debug</span> #f <span style="color: #40e0d0;">#:use-db?</span> #f
     <span style="color: #40e0d0;">#:dbd</span> #f <span style="color: #40e0d0;">#:db-username</span> #f <span style="color: #40e0d0;">#:db-passwd</span> #f <span style="color: #40e0d0;">#:db-name</span> #f)
</pre>
</div>

<p>
<i>You may see all the keyword is #f in default, this means these items will be gotten from config file.</i>
</p>

<p>
But you can specify them as will.
</p>

<p>
<code class="src src-scheme">#:host</code> specify the hostname.
</p>

<p>
<code class="src src-scheme">#:port</code> specify the socket port of the server.
</p>

<p>
<code class="src src-scheme">#:debug</code> set #t if you want to enable debug mode. Maybe verbose.
</p>

<p>
<code class="src src-scheme">#:use-db?</code> set #t if you want to use DB, and GNU Artanis will init DB config for you.
</p>

<p>
<code class="src src-scheme">#:dbd</code> choose dbd, there're three supported dbd: mysql, postgresql, and sqlite3.
</p>

<p>
<code class="src src-scheme">#:db-username</code> specify the username of your DB server.
</p>

<p>
<code class="src src-scheme">#:db-passwd</code> the DB password.
</p>

<p>
<code class="src src-scheme">#:db-name</code> specify DB name.
</p>
</div>
</div>
<div id="outline-container-orga4fb5d2" class="outline-3">
<h3 id="orga4fb5d2"><span class="section-number-3">7.6</span> Working with Nginx</h3>
<div class="outline-text-3" id="text-7-6">
<p>
You may try GNU Artanis+Nginx with so-called reverse proxy.
</p>

<p>
<b><i>Although GNU Artanis has good server core, I would recommend you use Nginx as the front server. In addition to the performance,
GNU Artanis hasn't prepared for many security things. But if you use Ngxin with reverse-proxy, then it'll be easier to be safer.</i></b>
</p>

<p>
For example, you may add these lines to your /etc/nginx/nginx.conf:
</p>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ffff;">location /</span> {
proxy_pass http://127.0.0.1:1234;
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
</pre>
</div>
<p>
Then restart you Nginx:
</p>

<div class="org-src-container">
<pre class="src src-null">sudo service nginx restart
</pre>
</div>

<p>
And run GNU Artanis:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(run <span style="color: #40e0d0;">#:port</span> 1234)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga7766cf" class="outline-2">
<h2 id="orga7766cf"><span class="section-number-2">8</span> The Art command line</h2>
<div class="outline-text-2" id="text-8">
<p>
GNU Artanis provides <b>art</b> command line tool to save users' time.
</p>
</div>
<div id="outline-container-org7292417" class="outline-3">
<h3 id="org7292417"><span class="section-number-3">8.1</span> art create</h3>
<div class="outline-text-3" id="text-8-1">
<p>
If you want to set up your site/app within an application folder, and take
advantage of MVC, you have to use this command to create the application
folder first.
</p>

<div class="org-src-container">
<pre class="src src-nil">art create proj_path
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb46ffe0" class="outline-3">
<h3 id="orgb46ffe0"><span class="section-number-3">8.2</span> art draw</h3>
<div class="outline-text-3" id="text-8-2">
<p>
This command will generate the specified component:
</p>
<div class="org-src-container">
<pre class="src src-nil">Usage:
  art draw &lt;component&gt; NAME [options]

component list:
  model
  controller
  migration

Options:
  -h, [--help]     # Print this screen
  -d, [--dry]      # Dry run but do not make any changes
  -f, [--force]    # Overwrite files that already exist
  -s, [--skip]     # Skip files that already exist
                   # If -s and -f are both provided, -f will be enabled
  -q, [--quiet]    # Suppress status output

Example:
  art draw model myblog
</pre>
</div>

<p>
Please see <a href="#orga7a1ef4">MVC</a> to learn more about how to use these components.
</p>
</div>
</div>
<div id="outline-container-org73bc13d" class="outline-3">
<h3 id="org73bc13d"><span class="section-number-3">8.3</span> art migrate</h3>
<div class="outline-text-3" id="text-8-3">
<p>
Migrate is used for Database migration.
</p>
<div class="org-src-container">
<pre class="src src-nil">Usage:
  art migrate operator name [OPTIONS]

Operators:
  up
  down

OPTIONS:
  VERSION=version
</pre>
</div>
<p>
Please see <a href="#orgaec5f55">Migration</a> for more detail.
</p>
</div>
</div>
<div id="outline-container-org0aa62c0" class="outline-3">
<h3 id="org0aa62c0"><span class="section-number-3">8.4</span> art work</h3>
<div class="outline-text-3" id="text-8-4">
<p>
This command is used to start the server to run your site in the application folder:
</p>
<div class="org-src-container">
<pre class="src src-nil">Usage:
  art work [options]

Options:
  -c, [--config=CONFIG]          # Specify config file
                                   Default: conf/artanis.conf
                                            if no, /etc/artanis/artanis.conf
  -h, [--host=HOST]              # Specify the network host
                                   Default: 0.0.0.0
  -d, [--usedb]                  # Whether to use Database
                                   Default: false
  -b, [--dbd=DBD]                # Specify DBD, mysql/postgresql/sqlit3
                                   Default: mysql
  -n, [--name=DATABASE_NAME]     # Database name
                                   Default: artanis
  -w, [--passwd=PASSWD]          # Database password
                                   Default: none
  -u, [--user=USER]              # Database user name
                                   Default: root
  -p, [--port=PORT]              # Specify listening port
                                   Default: 3000
  -g, [--debug]                  # Debug mode
                                   Default: disable
  -s, [--server=SERVER]          # Specify server core
                                   Default: Ragnarok (New server core since 0.2)
  --help                         # Show this screen
</pre>
</div>

<ul class="org-ul">
<li>For server core alternatives, please see <a href="#orgc5d1455">Server config</a>.</li>
<li>For Database (DBD) alternatives, please see <a href="#org9c7c6ad">Database config</a>.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org303ffad" class="outline-2">
<h2 id="org303ffad"><span class="section-number-2">9</span> URL remapping</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-org4b97be6" class="outline-3">
<h3 id="org4b97be6"><span class="section-number-3">9.1</span> Introduction to URL remapping</h3>
<div class="outline-text-3" id="text-9-1">
<p>
URL remapping is used to modify a web URL's appearance to provide short, pretty or fancy, search engine friendly URLs.
It's largely used in modern WAF(web application framework) to provide RESTful web APIs.
</p>
</div>
</div>
<div id="outline-container-orgc33255e" class="outline-3">
<h3 id="orgc33255e"><span class="section-number-3">9.2</span> URL handling</h3>
<div class="outline-text-3" id="text-9-2">
<p>
According to RFC2616, there are GET, POST, PUT, PATCH and DELETE methods. You may register handler for specified URL rule to these methods.
</p>

<p>
<i>There would be a HEAD method, but in GNU Artanis, the HEAD method is handled by the server, so users can not use it.</i>
</p>

<p>
The usage:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(method rule handler)
</pre>
</div>

<p>
And the handler could be one of two types, depending on your needs:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">lambda</span> ()
  ...
  ret)

(<span style="color: #4169e1;">lambda</span> (rc)
  ...
  ret)
</pre>
</div>

<p>
<b>ret</b> also has two types:
</p>

<ul class="org-ul">
<li>1. literal string as the returned response body</li>

<li>2. See <a href="#org5b6a522">Emit Response</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/hello"</span> (<span style="color: #4169e1;">lambda</span> () <span style="color: #ff0000;">"hello world"</span>))
</pre>
</div>

<p>
For POST method:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(post <span style="color: #ff0000;">"/auth"</span> (<span style="color: #4169e1;">lambda</span> (rc) ...))
</pre>
</div>
</div>
</div>
<div id="outline-container-org4fbc360" class="outline-3">
<h3 id="org4fbc360"><span class="section-number-3">9.3</span> Get parameters from URL</h3>
<div class="outline-text-3" id="text-9-3">
<div class="org-src-container">
<pre class="src src-scheme">(params rc name)
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">e.g</span>
(get <span style="color: #ff0000;">"/hello/:who"</span> (<span style="color: #4169e1;">lambda</span> (rc) (params rc <span style="color: #ff0000;">"who"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-orge567fbd" class="outline-3">
<h3 id="orge567fbd"><span class="section-number-3">9.4</span> Redirect link</h3>
<div class="outline-text-3" id="text-9-4">
<div class="org-src-container">
<pre class="src src-scheme">(redirect-to rc path <span style="color: #40e0d0;">#:status</span> 301
             <span style="color: #40e0d0;">#:scheme</span> 'http)
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">e.g</span>
(get <span style="color: #ff0000;">"/aaa"</span> (<span style="color: #4169e1;">lambda</span> (rc) (redirect-to rc <span style="color: #ff0000;">"/bbb"</span>)))
(get <span style="color: #ff0000;">"/bbb"</span> (<span style="color: #4169e1;">lambda</span> () <span style="color: #ff0000;">"ok bbb"</span>))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org45c5efd" class="outline-2">
<h2 id="org45c5efd"><span class="section-number-2">10</span> Route context</h2>
<div class="outline-text-2" id="text-10">
<p>
Route context is a struct which encapsulated server necessary information from the current request context.
We named it <i>route</i> because it's related to the route of <a href="#org303ffad">URL remapping</a>.
Usually it's passed to the page handler as the unique argument, it's expected to provide sufficient
information in the current request status.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(HTTP-METHOD URL-rule (<span style="color: #4169e1;">lambda</span> (<span style="color: #00ffff;">&lt;route-context&gt;</span>) ...))
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">e.g:</span>
(get <span style="color: #ff0000;">"/hello"</span> (<span style="color: #4169e1;">lambda</span> (rc) <span style="color: #ff0000;">"world"</span>)) <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">rc is &lt;route-context&gt; type</span>
</pre>
</div>
</div>

<div id="outline-container-org1945182" class="outline-3">
<h3 id="org1945182"><span class="section-number-3">10.1</span> Route context APIs</h3>
<div class="outline-text-3" id="text-10-1">
<div class="org-src-container">
<pre class="src src-scheme">(rc-path <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>Get the requested path, that is to say, the actual URI visited by the client.</li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">e.g</span>
(get <span style="color: #ff0000;">"/hello/world"</span> (<span style="color: #4169e1;">lambda</span> (rc) (rc-path rc)))
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">visit localhost:3000/hello/world or from any port you specified</span>
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">the result is "/hello/world".</span>
(get <span style="color: #ff0000;">"/hello/:who"</span> (<span style="color: #4169e1;">lambda</span> (rc) (rc-path rc)))
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">visit localhost:3000/hello/world or from any port you specified</span>
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">the result is "/hello/world".</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme">(rc-req <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>Get the current HTTP request wrapped in record-type. About HTTP request
please see <a href="https://www.gnu.org/software/guile/manual/html_node/Requests.html">HTTP Request</a>. It stores HTTP request of Guile.</li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(rc-body <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>Get the current request body:
<ul class="org-ul">
<li>For a regular HTTP request, the body should be a bytevector;</li>
<li>For a Websocket request, the body should be <a href="#orged071d9">Websocket frame</a> as a record-type.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(rc-method <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>Get the current requested HTTP method.</li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(rc-conn <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>Get the current DB connection if you've requested one, please checkout [BROKEN LINK: nil].</li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(rc-qt <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>Get query table, which is a key-value list parsed from <a href="#orge2af7f5">query string</a>.</li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(rc-handler <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>Get the current request handler. The tricky part is that you can only get this handler
within this handler unless you can go no where to run <i>rc-handler</i> correctly.
<ul class="org-ul">
<li>It's on your own risk to use this API. But now that we have powerful first class lambda,
you may do some magic. Well, depends on you.</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(rc-mtime <span style="color: #00ffff;">&lt;route-context&gt;</span>) <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">getter</span>
(rc-mtime! <span style="color: #00ffff;">&lt;route-context&gt;</span>) <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">setter</span>
</pre>
</div>
<ul class="org-ul">
<li>You may set it in the handler to return you customized modified time.
For static pages, the mtime is set automatically. But sometimes people
may want to set it in a dynamic generated page.</li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(rc-cookie <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>The cookies parsed from request header.</li>
</ul>

<div class="org-src-container">
<pre class="src src-scheme">(rc-set-cookie! <span style="color: #00ffff;">&lt;route-context&gt;</span>)
</pre>
</div>
<ul class="org-ul">
<li>Set response cookie from server side. If you want to return cookies to
the client, please use it.</li>
</ul>

<p>
There're other APIs in <i>route-context</i>, but they're largely used for
internals of Artanis, rarely useful for users. So we don't list them here.
</p>
</div>
</div>
</div>
<div id="outline-container-orga7a1ef4" class="outline-2">
<h2 id="orga7a1ef4"><span class="section-number-2">11</span> MVC</h2>
<div class="outline-text-2" id="text-11">
<p>
MVC is Model-Views-Controller, the most classic architectural pattern for implementing
user interfaces.
It divides a given software application into three interconnected parts, so as to
separate internal representations of information from the ways that information is
presented to or accepted from the user.
</p>
</div>
<div id="outline-container-org4bad1b7" class="outline-3">
<h3 id="org4bad1b7"><span class="section-number-3">11.1</span> Controllers/Views</h3>
<div class="outline-text-3" id="text-11-1">
<p>
When you run it to generate a controller named <i>article</i>:
</p>
<div class="org-src-container">
<pre class="src src-nil">art draw controller article show edit
</pre>
</div>

<p>
<i>show</i> and <i>edit</i> are the name of methods for the controller named <i>article</i>.
</p>

<p>
And it'll generate both <b>controller</b> and <b>view</b> for <i>article</i>:
</p>
<div class="org-src-container">
<pre class="src src-nil">drawing    controller article
working    Controllers `article.scm'
create     app/controllers/article.scm
working    Views `article'
create     app/views/article/show.html.tpl
create     app/views/article/edit.html.tpl
</pre>
</div>

<p>
As you may see, there're three files were generated:
</p>
<div class="org-src-container">
<pre class="src src-nil">app/controllers/article.scm
app/views/article/show.html.tpl
app/views/article/edit.html.tpl
</pre>
</div>

<p>
This means the controller <i>article</i> has two methods mapped to URL rule named <i>show</i> and <i>edit</i>.
And <i>view</i> component will generate HTML template for each method, say, <b>show.html.tpl</b>.
For example, the controller <i>article</i> generate <i>show</i> method handler automatically:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(article-define show
                (<span style="color: #4169e1;">lambda</span> (rc)
                  <span style="color: #ff0000;">"&lt;h1&gt;This is article#show&lt;/h1&gt;&lt;p&gt;Find me in app/views/article/show.html.tpl&lt;/p&gt;"</span>
                  <span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">TODO: add controller method `show'</span>
                  <span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">uncomment this line if you want to render view from template</span>
                  <span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">(view-render "show")</span>
                  ))
</pre>
</div>
<p>
Of course, it depends on you whether to use these template. If you want to use <i>view template</i>, just
uncomment the last line <code class="src src-scheme">(view-render "show")</code>.
</p>

<p>
For more detail about template in Views, please see <a href="#orgcede7fa">Layouts and Rendering in GNU Artanis</a>.
</p>
</div>
</div>
<div id="outline-container-orga692f2c" class="outline-3">
<h3 id="orga692f2c"><span class="section-number-3">11.2</span> Models</h3>
<div class="outline-text-3" id="text-11-2">
<p>
Models contains operations of database.
</p>

<p>
For modifying tables, you should read <a href="#orgaec5f55">Migration</a>.
</p>

<p>
For other DB operation, please read <a href="#org06fa2ad">FPRM</a>.
</p>

<p>
(To be continue&#x2026;)
</p>
</div>
</div>
</div>
<div id="outline-container-orge2af7f5" class="outline-2">
<h2 id="orge2af7f5"><span class="section-number-2">12</span> Query String</h2>
<div class="outline-text-2" id="text-12">
<p>
Query string is a special form of URL:
</p>

<div class="org-src-container">
<pre class="src src-bash">http://example.com/over/there?<span style="color: #00ff00;">name</span>=ferret&amp;<span style="color: #00ff00;">color</span>=purple
</pre>
</div>

<p>
It's useful to pass parameters to the server side.
</p>

<p>
GNU Artanis provides convenient API to handle query strings.
</p>
</div>

<div id="outline-container-org719cf7c" class="outline-3">
<h3 id="org719cf7c"><span class="section-number-3">12.1</span> Query string from GET</h3>
<div class="outline-text-3" id="text-12-1">
<p>
The query string would be encoded in URL if the method is GET.
</p>

<div class="org-src-container">
<pre class="src src-bash">http://example.com/over/there?<span style="color: #00ff00;">name</span>=ferret&amp;<span style="color: #00ff00;">color</span>=purple
</pre>
</div>
<p>
Please notice that URL-remapping support regex, so you should register URL rule like this:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/there?"</span>
  (<span style="color: #4169e1;">lambda</span> (rc)
    (get-from-qstr rc <span style="color: #ff0000;">"name"</span>)))
</pre>
</div>
<p>
Or it will throw 404 since URL-remapping failed to hit the rule with query string.
</p>
</div>
</div>
<div id="outline-container-orgbd8bcac" class="outline-3">
<h3 id="orgbd8bcac"><span class="section-number-3">12.2</span> Query string from POST</h3>
<div class="outline-text-3" id="text-12-2">
<p>
The query string would be encoded in HTTP body if the method were POST.
</p>

<p>
There's only slitely difference when you pass query string by POST: you don't have to
use regex, for example, "?" for matching the URL.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(post <span style="color: #ff0000;">"/there"</span>
  (<span style="color: #4169e1;">lambda</span> (rc)
    (get-from-qstr rc <span style="color: #ff0000;">"name"</span>)))
</pre>
</div>
<p>
GNU Artanis will detect the method type in <i>get-from-qstr</i>, if it's POST, then the router
will parse query string from the HTTP body automatically.
</p>
</div>
</div>
</div>

<div id="outline-container-orgcede7fa" class="outline-2">
<h2 id="orgcede7fa"><span class="section-number-2">13</span> Layouts and Rendering in GNU Artanis</h2>
<div class="outline-text-2" id="text-13">
</div><div id="outline-container-orgb3aa6c2" class="outline-3">
<h3 id="orgb3aa6c2"><span class="section-number-3">13.1</span> Templating</h3>
<div class="outline-text-3" id="text-13-1">
<p>
Templating provides a way to mix programming code into HTML.
</p>
</div>
</div>
<div id="outline-container-org92eec3e" class="outline-3">
<h3 id="org92eec3e"><span class="section-number-3">13.2</span> Templating for Pythoners</h3>
<div class="outline-text-3" id="text-13-2">
<p>
If you're familiar with Django, which implemented a DSL(Domain Specific Language) to express presentation rather than program logic. You may realize that the templating of GNU Artanis has different philosophy.
</p>

<p>
In templating of GNU Artanis, it's simply embedded Scheme code into HTML. Why? Because of the philosophy of FP(Functional Programming), everything could be a function. So obviously, <code class="src src-scheme">(filesizeformat size)</code> is enough for understanding, and it's just simple function calling in prefix-notation. There's no need to implement DSL like <code class="src src-python">size|filesizeformat</code> to increase the complexity of code. Let alone the syntax is very different from Python.
</p>

<p>
The syntax like <code class="src src-python">size | filesizeformat</code> is postfix-notation used in stack-based languages, say Forth. Such a language used to delegate another programming paradigm named concatenative programming. It's very different from the paradigm of Scheme (functional programming), and the paradigm of Python (imperative programming).
</p>

<p>
The philosophy of GNU Artanis templating is to bring it into correspondence with the paradigm of the language. And reduce the unnecessary complexities. <a href="http://en.wikipedia.org/wiki/KISS_principle">KISS</a>.
</p>
</div>
</div>
<div id="outline-container-orgbccbe9d" class="outline-3">
<h3 id="orgbccbe9d"><span class="section-number-3">13.3</span> Templating for Rubyists</h3>
<div class="outline-text-3" id="text-13-3">
<p>
Templating in GNU Artanis looks very similar to Rails.
</p>

<p>
The Rails code:
</p>

<div class="org-src-container">
<pre class="src src-python">&lt;% <span style="color: #4169e1;">if</span>( @fullscreen == 1 ) %&gt;
&lt;%= <span style="color: #ff0000;">"&lt;div class='full'&gt;&lt;p&gt;...&lt;/p&gt;&lt;/div&gt;"</span> %&gt;
&lt;% end %&gt;
</pre>
</div>

<p>
And the same function in GNU Artanis code:
</p>

<div class="org-src-container">
<pre class="src src-scheme">&lt;% (<span style="color: #4169e1;">if</span> (= fullscreen 1) %&gt;
       &lt;% <span style="color: #ff0000;">"&lt;div class='full'&gt;&lt;p&gt;...&lt;/p&gt;&lt;/div&gt;"</span> %&gt;
       &lt;% ) %&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-org90c19d2" class="outline-3">
<h3 id="org90c19d2"><span class="section-number-3">13.4</span> Templating APIs</h3>
<div class="outline-text-3" id="text-13-4">
<div class="org-src-container">
<pre class="src src-scheme">(tpl-&gt;response filename/sxml [environment &lt;- (the-environment)] [escape? &lt;- #f])

(tpl-&gt;html filename/sxm [environment &lt;- (the-environment)] [escape? &lt;- #f])
</pre>
</div>

<p>
<i>The difference is that tpl-&gt;html returns a string, but tpl-&gt;response will return HTTP response.</i>
</p>

<p>
[environment] is the environment you want to pass in. We often ignore it. But if you want to ref some vars defined outside your
template string, you should pass (the-environment).
</p>

<p>
[escape?] If you want to HTML char-escaping with the returned string, set it to #t.
</p>

<p>
There're two kinds of different templating:
</p>
</div>
</div>
<div id="outline-container-orgaf3562f" class="outline-3">
<h3 id="orgaf3562f"><span class="section-number-3">13.5</span> Embedded Templating</h3>
<div class="outline-text-3" id="text-13-5">
<p>
Example:
Write a tpl file named "my.tpl":
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #ffd700;">html</span>&gt;
  &lt;<span style="color: #ffd700;">p</span>&gt; &lt;%= <span style="color: #ff0000;">"This is tpl test!"</span> %&gt; &lt;/<span style="color: #ffd700;">p</span>&gt;
  &lt;<span style="color: #ffd700;">p</span>&gt; &lt;% (format #t <span style="color: #ff0000;">"And this is ~a"</span> (getcwd)) %&gt; &lt;/<span style="color: #ffd700;">p</span>&gt;
  &lt;<span style="color: #ffd700;">p</span>&gt; &lt;%= external-var %&gt; &lt;/<span style="color: #ffd700;">p</span>&gt;
&lt;/<span style="color: #ffd700;">html</span>&gt;
</pre>
</div>

<p>
The filename extension ".tpl" is NOT trivial, since the MVC will find the template by detecting
controller name automatically. But if you don't use MVC, say, you just write a simple .scm
file for loading GNU Artanis modules. then the extension filename ".tpl" is trivial.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/test"</span>
  (<span style="color: #4169e1;">lambda</span> (rc)
    (<span style="color: #4169e1;">let</span> ((external-var 123))
      (tpl-&gt;response <span style="color: #ff0000;">"my.tpl"</span> (the-environment)))))
(run <span style="color: #40e0d0;">#:port</span> 8080)
</pre>
</div>

<p>
In this case, make sure to put my.tpl to the same path with your GNU Artanis code.
</p>

<p>
Because <b>external-var</b> is defined outside the file "my.tpl", and it's bound in <i>let</i> with 123, you have to pass (the-environment). Or the template render will blame that it can't find variable named <b>external-var</b>.
</p>

<p>
If you don't have any external var needs to be referenced, just use <code class="src src-scheme">(tpl->response "file.tpl")</code> is fine.
</p>

<p>
Then see <a href="http://localhost:3000/test">http://localhost:3000/test</a> in your browser.
</p>
</div>
</div>

<div id="outline-container-orgda5784a" class="outline-3">
<h3 id="orgda5784a"><span class="section-number-3">13.6</span> Template special commands</h3>
<div class="outline-text-3" id="text-13-6">
<p>
GNU Artanis provide special helper commands.
</p>

<p>
Please notice that GNU Artanis constrains the path of sources in application folder for
security reasons. The resources files, CSS, JS etc, should be put int <b>pub</b> directory in
the application folder, or the client can't access them.
</p>

<p>
Those special commands are useful to expand the path for you, and they should be added
into the tamplate file, for example:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #ffd700;">html</span>&gt;
  &lt;<span style="color: #ffd700;">head</span>&gt;
    &lt;@icon favicon.ico %&gt;
      &lt;@js functions.js %&gt;
        &lt;@css blog.css %&gt;
  &lt;/<span style="color: #ffd700;">head</span>&gt;

  &lt;@include sidebar.html %&gt;

    &lt;<span style="color: #ffd700;">body</span>&gt;
      ...
    &lt;/<span style="color: #ffd700;">body</span>&gt;
&lt;/<span style="color: #ffd700;">html</span>&gt;
</pre>
</div>

<p>
<b>NOTE:</b> The command name is prefixed with <b>@</b>, say, <b>@include</b>, <b>@css</b>, etc. Please do
not seperate the <b>@</b>, or it will throw excepton.
</p>

<p>
For example, you may include html files with <b>include</b> command:
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">@include is the command name, not &lt;@ include filename %&gt;</span>
&lt;@include filename.html %&gt;
</pre>
</div>
<p>
This will be expanded like this:
</p>
<div class="org-src-container">
<pre class="src src-bash">/current_toplevel/pub/filename.html
</pre>
</div>
<p>
<b>NOTE:</b> Please make sure the included file is put to <b>pub</b> directory in the application
folder.
</p>

<p>
To reference CSS file:
</p>
<div class="org-src-container">
<pre class="src src-scheme">&lt;@css filename.css %&gt;
</pre>
</div>
<p>
This will be expanded like this:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #ffd700;">link</span> <span style="color: #00ff00;">rel</span>=<span style="color: #ff0000;">"stylesheet"</span> <span style="color: #00ff00;">href</span>=<span style="color: #ff0000;">"/pub/css/filename.css"</span>&gt;
</pre>
</div>

<p>
To reference JS file in the HTML head:
</p>
<div class="org-src-container">
<pre class="src src-scheme">&lt;@js filename.js %&gt;
</pre>
</div>
<p>
This will be expanded like this:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #ffd700;">script</span> <span style="color: #00ff00;">type</span>=<span style="color: #ff0000;">"text/javascript"</span> <span style="color: #00ff00;">src</span>=<span style="color: #ff0000;">"/pub/js/filename.js"</span>&gt; &lt;/<span style="color: #ffd700;">script</span>&gt;
</pre>
</div>

<p>
To specify the icon:
</p>
<div class="org-src-container">
<pre class="src src-scheme">&lt;@icon favicon.ico %&gt;
</pre>
</div>
<p>
This will be expanded like this:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #ffd700;">link</span> <span style="color: #00ff00;">rel</span>=<span style="color: #ff0000;">"icon"</span> <span style="color: #00ff00;">href</span>=<span style="color: #ff0000;">"/pub/img/favicon.ico"</span> <span style="color: #00ff00;">type</span>=<span style="color: #ff0000;">"image/x-icon"</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org66925d6" class="outline-3">
<h3 id="org66925d6"><span class="section-number-3">13.7</span> SXML Templating</h3>
<div class="outline-text-3" id="text-13-7">
<p>
<a href="http://en.wikipedia.org/wiki/SXML">SXML</a> is an alternative syntax for writing XML data, using the form of S-expressions.
</p>

<p>
SXML is to Scheme as JSON is to ECMAScript(the so-called Javascript). Maybe this explains clearer.
</p>

<p>
The benefit of SXML is to take advantage of quasiquote in Scheme. If you no little about it, then you may google "scheme quasiquote" for more details.
</p>

<div class="org-src-container">
<pre class="src src-scheme">(tpl-&gt;response '(html (body (p (@ (id <span style="color: #ff0000;">"content"</span>)) <span style="color: #ff0000;">"hello world"</span>))))
</pre>
</div>

<p>
You would get a html string:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="color: #ffd700;">html</span>&gt;&lt;<span style="color: #ffd700;">body</span>&gt;&lt;<span style="color: #ffd700;">p</span> <span style="color: #00ff00;">id</span>=<span style="color: #ff0000;">"content"</span>&gt;hello world&lt;/<span style="color: #ffd700;">p</span>&gt;&lt;/<span style="color: #ffd700;">body</span>&gt;&lt;/<span style="color: #ffd700;">html</span>&gt;
</pre>
</div>

<p>
Sometimes you may need quasiquote to reference a variable, for example:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">let</span> ((content <span style="color: #ff0000;">"hello world"</span>))
  (tpl-&gt;response `(html (body (p (@ (id <span style="color: #ff0000;">"content"</span>)) ,content)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1952520" class="outline-2">
<h2 id="org1952520"><span class="section-number-2">14</span> Database</h2>
<div class="outline-text-2" id="text-14">
</div><div id="outline-container-orgedc0190" class="outline-3">
<h3 id="orgedc0190"><span class="section-number-3">14.1</span> DB connection pool</h3>
<div class="outline-text-3" id="text-14-1">
<p>
TODO
</p>
</div>
</div>
<div id="outline-container-orgaec5f55" class="outline-3">
<h3 id="orgaec5f55"><span class="section-number-3">14.2</span> Migration</h3>
<div class="outline-text-3" id="text-14-2">
<p>
Migration provides a way do complicated modification of tables in database automatically.
Here's an example.
</p>

<p>
First, draw a migration:
</p>
<div class="org-src-container">
<pre class="src src-nil"># art draw migration person
drawing    migration person
working    Migration `20151107040209_person.scm'
</pre>
</div>
<p>
You'll see something similar like above.
</p>

<p>
In this case, you may edit file db/migration/20151107040209_person.scm:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(migrate-up
 (create-table
  'person
  '(id auto (<span style="color: #40e0d0;">#:primary-key</span>))
  '(name char-field (<span style="color: #40e0d0;">#:not-null</span> <span style="color: #40e0d0;">#:maxlen</span> 10))
  '(age tiny-integer (<span style="color: #40e0d0;">#:not-null</span>))
  '(email char-field (<span style="color: #40e0d0;">#:maxlen</span> 20))))

(migrate-down
 (drop-table 'person))
</pre>
</div>

<p>
Now you may run <b>up</b> command of migration:
</p>
<div class="org-src-container">
<pre class="src src-nil">art migrate up person
</pre>
</div>

<p>
Then migrate-up function will be called, and this will create a table named <i>person</i>:
</p>
<div class="org-src-container">
<pre class="src src-nil">+-------+---------------------+------+-----+---------+----------------+
| Field | Type                | Null | Key | Default | Extra          |
+-------+---------------------+------+-----+---------+----------------+
| id    | bigint(20) unsigned | NO   | PRI | NULL    | auto_increment |
| name  | varchar(10)         | NO   |     | NULL    |                |
| age   | tinyint(4)          | NO   |     | NULL    |                |
| email | varchar(20)         | YES  |     | NULL    |                |
+-------+---------------------+------+-----+---------+----------------+
</pre>
</div>

<p>
If you run <b>down</b> command of migration:
</p>
<div class="org-src-container">
<pre class="src src-nil">art migrate down person
</pre>
</div>
<p>
Obviously, the table <i>person</i> will be dropped.
</p>
</div>
</div>
<div id="outline-container-orga5be064" class="outline-3">
<h3 id="orga5be064"><span class="section-number-3">14.3</span> ORM problem</h3>
<div class="outline-text-3" id="text-14-3">
<p>
ORM stands for Object Relational Mapping, which is a popular approach to handle relational DB nowadays, in OOP.
</p>

<p>
Of course, Guile has it's own Object System named <a href="https://www.gnu.org/software/guile/manual/html_node/GOOPS.html#GOOPS">GOOPS</a>. Users may use OOP with it. And it's possible to implement ORM in GNU Artanis as well.
</p>

<p>
However, FP fans realized that they don't have to use OOP if they can use FP features reasonably.
</p>

<p>
Besides, there're some criticism pointing to ORM:
</p>
<ul class="org-ul">
<li><a href="http://martinfowler.com/bliki/OrmHate.html">ORM Hate</a></li>

<li><a href="http://blogs.tedneward.com/2006/06/26/The+Vietnam+Of+Computer+Science.aspx">Vietnam of Computer Science</a></li>

<li><a href="http://blog.codinghorror.com/object-relational-mapping-is-the-vietnam-of-computer-science/">Object-Relational Mapping is the Vietnam of Computer Science</a></li>
</ul>

<p>
And here're some known ways for trying to solve the problems of ORM:
</p>

<ul class="org-ul">
<li>1. <b><i>Give up ORM</i></b>.</li>
</ul>


<ul class="org-ul">
<li>2. <b><i>Give up relational storage model</i></b>. Don't use relational DB, pick up others, say, No-SQL. Well, this way is not cool when you have to use relational DB.</li>
</ul>


<ul class="org-ul">
<li>3. <b><i>Manual mapping</i></b>. Write SQL code directly. It's fine sometimes. But the code increases when things get complicated. Refactoring and reusing would be worth to consider.</li>
</ul>


<ul class="org-ul">
<li>4. <b><i>Limited ORM</i></b>. Limited the utility of ORM. And use ORM to solve part of your work rather than whole, depends on you. This may avoid some problems.</li>
</ul>


<ul class="org-ul">
<li>5. <b><i>SQL related DSL</i></b>. Design a new language. LINQ from Microsoft is one of the cases.</li>
</ul>


<ul class="org-ul">
<li>6. <b><i>Integration of relational concepts into frameworks</i></b>. Well, harder than 5, but worth to try.</li>
</ul>


<ul class="org-ul">
<li>7. <b><i>Stateless</i></b>. This is the critical hit to counter complexity and unreliability.</li>
</ul>

<p>
Basically, GNU Artanis has no ORM yet, and maybe never will. GNU Artanis is trying to experiment new ways to solve the problems of ORM.
</p>

<p>
GNU Artanis provides three ways to complete this mission. All of them, are <b>experimental</b> at present.
</p>

<ul class="org-ul">
<li>SSQL (1,3,5)</li>

<li>FPRM (4,7)</li>

<li>SQL Mapping (1,3,6)</li>
</ul>
</div>
</div>
<div id="outline-container-org9b11454" class="outline-3">
<h3 id="org9b11454"><span class="section-number-3">14.4</span> SSQL (experimental)</h3>
<div class="outline-text-3" id="text-14-4">
<p>
The concept of SSQL is very easy. Write SQL in <a href="https://en.wikipedia.org/wiki/S-expression">s-expression</a>.
</p>

<p>
Usage:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(-&gt;sql sql-statement)
(where <span style="color: #40e0d0;">#:key</span> val ... [literal string])
(having <span style="color: #40e0d0;">#:key</span> val ... [literal string])
(/or conds ...)
(/and conds ...)
</pre>
</div>

<p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(-&gt;sql select * from 'Persons (where <span style="color: #40e0d0;">#:city</span> <span style="color: #ff0000;">"Shenzhen"</span>))
(-&gt;sql select '(age name) from 'Persons (where <span style="color: #ff0000;">"age &lt; 30"</span>))
</pre>
</div>
<p>
The SQL update maybe quite different to SQL grammar, it should like blow.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(-&gt;sql update 'table set (list (list phone_number <span style="color: #ff0000;">"13666666666"</span>)) (where <span style="color: #40e0d0;">#:name</span> <span style="color: #ff0000;">"john"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-org06fa2ad" class="outline-3">
<h3 id="org06fa2ad"><span class="section-number-3">14.5</span> FPRM (experimental)</h3>
<div class="outline-text-3" id="text-14-5">
<p>
FPRM stands for Functional Programming Relational Mapping. It's a new word I invented. But it's not new concept. FP here indicates <b>stateless</b>.
</p>

<p>
<i>FPRM is still experimental and work-in-progress.</i>
</p>
</div>
<div id="outline-container-org51d8e2d" class="outline-4">
<h4 id="org51d8e2d"><span class="section-number-4">14.5.1</span> Connect to DB server</h4>
<div class="outline-text-4" id="text-14-5-1">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">usage 1:</span>
(connect-db dbd init-str)

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">usage 2:</span>
(connect-db dbd <span style="color: #40e0d0;">#:db-name</span> <span style="color: #ff0000;">"artanis"</span> <span style="color: #40e0d0;">#:db-username</span> <span style="color: #ff0000;">"root"</span> <span style="color: #40e0d0;">#:db-passwd</span> <span style="color: #ff0000;">""</span>
            <span style="color: #40e0d0;">#:proto</span> <span style="color: #ff0000;">"tcp"</span> <span style="color: #40e0d0;">#:host</span> <span style="color: #ff0000;">"localhost"</span> <span style="color: #40e0d0;">#:port</span> 3306)
</pre>
</div>

<ul class="org-ul">
<li><b>dbd</b> is a string, could be "mysql", "postgresql", and "sqlite3".</li>
</ul>


<ul class="org-ul">
<li><b>init-str</b> is a string for DB init, for example:</li>
</ul>
<div class="org-src-container">
<pre class="src src-scheme">(connect-db <span style="color: #ff0000;">"mysql"</span> <span style="color: #ff0000;">"root:123:artanis:tcp:localhost:3306"</span>)
</pre>
</div>

<ul class="org-ul">
<li><code class="src src-scheme">#:db-name</code> specifies the DB name.</li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:db-username</code> specifies the DB username.</li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:proto</code> specifies the socket protocol, which is related to DB server you chosen.</li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:host</code> specifies the host name.</li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:port</code> specifies the socket port.</li>
</ul>
</div>
</div>
<div id="outline-container-org0c00fc5" class="outline-4">
<h4 id="org0c00fc5"><span class="section-number-4">14.5.2</span> Map DB table</h4>
<div class="outline-text-4" id="text-14-5-2">
<p>
This step will generate an new instance (as a closure) mapped to database table or view.
In ORM, it is often called <a href="http://www.martinfowler.com/eaaCatalog/activeRecord.html">Active Record</a> which maps the database view to an class object.
</p>

<p>
And there're two differences:
</p>
<ul class="org-ul">
<li>FPRM doesn't create object for each table. It maps a whole database in concept, and generates SQL for each table as you choose. So it maybe lightweight compared to an ORM object.</li>
<li>FPRM doesn't maintain any states at all, say, it keeps stateless in the object (Not in database).</li>
</ul>

<p>
These two points may decrease the power of FPRM, but our main philosophy in GNU Artanis is that
</p>
<ul class="org-ul">
<li><i>The best way to control DB is SQL, don't bother with other guile schemes.</i></li>
</ul>

<p>
That means we're not going to develop a complicated ORM in GNU Artanis, but a promising way to interact with SQL easily.
This is what <a href="#org37320aa">SQL Mapping</a> provided. FPRM aims to reduce states &amp; complexity to provide reliability, and SQL-Mapping will provide a convenient way
to handle complex SQL for better performance and security (from SQL-Injection).
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">define</span> <span style="color: #ffd700;">m</span> (map-table-from-DB rc/conn))
</pre>
</div>

<p>
<b>rc/conn</b> can be route-context or connection of DB.
</p>

<p>
map-table-from-DB returns a function, we named it <b>m</b> here for explaining.
</p>
</div>
</div>
<div id="outline-container-org982516b" class="outline-4">
<h4 id="org982516b"><span class="section-number-4">14.5.3</span> Create table</h4>
<div class="outline-text-4" id="text-14-5-3">
<div class="org-src-container">
<pre class="src src-scheme">(m 'create table-name defs <span style="color: #40e0d0;">#:if-exists?</span> #f <span style="color: #40e0d0;">#:primary-keys</span> '() <span style="color: #40e0d0;">#:engine</span> #f)
</pre>
</div>

<ul class="org-ul">
<li><b>table-name</b> specifies the name of the table in DB.</li>
</ul>


<ul class="org-ul">
<li><b>defs</b> is a list to define the columns' types. For example:</li>
</ul>
<div class="org-src-container">
<pre class="src src-scheme">'((name varchar 10) (age integer) (email varchar 20))
</pre>
</div>


<ul class="org-ul">
<li><code class="src src-scheme">#:if-exists?</code> has two kinds of possible options:
<ul class="org-ul">
<li>'<b>overwrite</b> or '<b>drop</b> means overwriting the existed table if possible.</li>
<li>'<b>ignore</b> means ignore the table when there's an existed one.</li>
</ul></li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:primary-keys</code> specifies the primary keys in the created table.</li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:engine</code> specifies the engine, depends on the dbd you chosen.</li>
</ul>
</div>
</div>
<div id="outline-container-orga23b176" class="outline-4">
<h4 id="orga23b176"><span class="section-number-4">14.5.4</span> Get columns from table</h4>
<div class="outline-text-4" id="text-14-5-4">
<div class="org-src-container">
<pre class="src src-scheme">(m 'get table-name <span style="color: #40e0d0;">#:columns</span> '(*) <span style="color: #40e0d0;">#:functions</span> '() <span style="color: #40e0d0;">#:ret</span> 'all
   <span style="color: #40e0d0;">#:group-by</span> #f <span style="color: #40e0d0;">#:order-by</span> #f)
</pre>
</div>

<ul class="org-ul">
<li><code class="src src-scheme">#:column</code> is the columns list you wanted.</li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:functions</code> is built-in functions calling, e.g:</li>
</ul>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #40e0d0;">#:functions</span> '((count Persons.Lastname))
</pre>
</div>


<ul class="org-ul">
<li><code class="src src-scheme">#:ret</code> specifies how to return the result, there're three options:
<ul class="org-ul">
<li>'all for returning all results</li>
<li>'top for returning the first result</li>
<li>integer (larger than 0), you specify the number.</li>
</ul></li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:group-by</code> used in conjunction with the aggregate functions to group the result-set by one or more columns.</li>
</ul>


<ul class="org-ul">
<li><code class="src src-scheme">#:order-by</code> used to sort the result-set by one or more columns.</li>
</ul>


<p>
For example, to get Lastname and City column, and return the first result.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(m 'get 'Persons <span style="color: #40e0d0;">#:columns</span> '(Lastname City) <span style="color: #40e0d0;">#:ret</span> 'top)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd223865" class="outline-4">
<h4 id="orgd223865"><span class="section-number-4">14.5.5</span> Set values to table</h4>
<div class="outline-text-4" id="text-14-5-5">
<div class="org-src-container">
<pre class="src src-scheme">(m 'set table-name . kargs)
</pre>
</div>

<p>
<b>kargs</b> is a var-list to accept the key-value arguments.
</p>

<p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(m 'set 'Persons <span style="color: #40e0d0;">#:name</span> <span style="color: #ff0000;">"nala"</span> <span style="color: #40e0d0;">#:age</span> 99 <span style="color: #40e0d0;">#:email</span> <span style="color: #ff0000;">"nala@artanis.com"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org4cf87fb" class="outline-4">
<h4 id="org4cf87fb"><span class="section-number-4">14.5.6</span> Drop a table</h4>
<div class="outline-text-4" id="text-14-5-6">
<div class="org-src-container">
<pre class="src src-scheme">(m 'drop table-name)
</pre>
</div>
</div>
</div>
<div id="outline-container-org2085a5b" class="outline-4">
<h4 id="org2085a5b"><span class="section-number-4">14.5.7</span> Check existence of table</h4>
<div class="outline-text-4" id="text-14-5-7">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">case sensitive</span>
(m 'exists? table-name . columns)
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">or for case-insensitive</span>
(m 'ci-exists? table-name . columns)
</pre>
</div>

<p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(m 'exists? 'Persons 'city 'lastname)
</pre>
</div>
</div>
</div>
<div id="outline-container-org8a36b28" class="outline-4">
<h4 id="org8a36b28"><span class="section-number-4">14.5.8</span> Get schema of a table</h4>
<div class="outline-text-4" id="text-14-5-8">
<div class="org-src-container">
<pre class="src src-scheme">(m 'schema table-name)
</pre>
</div>

<p>
<i>NOTE: all the returned name of schema will be down-cased.</i>
</p>
</div>
</div>
</div>
<div id="outline-container-org37320aa" class="outline-3">
<h3 id="org37320aa"><span class="section-number-3">14.6</span> SQL Mapping (experimental)</h3>
<div class="outline-text-3" id="text-14-6">
<p>
To be continued &#x2026;
</p>
</div>
</div>
</div>
<div id="outline-container-org70ca296" class="outline-2">
<h2 id="org70ca296"><span class="section-number-2">15</span> MIME</h2>
<div class="outline-text-2" id="text-15">
<p>
<code class="src src-scheme">#:mime</code> method is used to return the proper MIME type in the HTTP response.
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #40e0d0;">#:mime</span> type <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">for registering type</span>
(<span style="color: #40e0d0;">:mime</span> rc body) <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">for emit the reponse with the proper MIME</span>
</pre>
</div>
</div>
<div id="outline-container-orgf3d8492" class="outline-3">
<h3 id="orgf3d8492"><span class="section-number-3">15.1</span> JSON</h3>
<div class="outline-text-3" id="text-15-1">
<p>
GNU Artanis integrated the third-party module <a href="https://github.com/aconchillo/guile-json">guile-json</a>.
You may use #:mime method to handle JSON:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/json"</span> <span style="color: #40e0d0;">#:mime</span> 'json
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #4169e1;">let</span> ((j (json (object (<span style="color: #ff0000;">"name"</span> <span style="color: #ff0000;">"nala"</span>) (<span style="color: #ff0000;">"age"</span> 15)))))
         (<span style="color: #40e0d0;">:mime</span> rc j))))
</pre>
</div>

<p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">define</span> <span style="color: #ffd700;">my-json</span>
  (json (object (<span style="color: #ff0000;">"name"</span> <span style="color: #ff0000;">"nala"</span>) (<span style="color: #ff0000;">"age"</span> 15)
                (<span style="color: #ff0000;">"read_list"</span>
                 (object
                  (<span style="color: #ff0000;">"book1"</span> <span style="color: #ff0000;">"The interpreter and structure of Artanis"</span>)
                  (<span style="color: #ff0000;">"book2"</span> <span style="color: #ff0000;">"The art of Artanis programming"</span>))))))
(scm-&gt;json my-json) <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">scm-&gt;json will print json</span>
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">==&gt; {"name" : "nala",</span>
<span style="color: #66cdaa;">;;      </span><span style="color: #66cdaa;">"age" : 15,</span>
<span style="color: #66cdaa;">;;      </span><span style="color: #66cdaa;">"read_list" : {"book2" : "The art of Artanis programming",</span>
<span style="color: #66cdaa;">;;                     </span><span style="color: #66cdaa;">"book1" : "The interpreter and structure of Artanis"}}</span>
</pre>
</div>

<p>
<code class="src src-scheme">scm->json</code> will print the result directly.
</p>

<p>
If you need to format JSON as a string to return to clients, please use <code class="src src-scheme">scm->json-string</code>.
</p>
</div>
</div>
<div id="outline-container-orgd598a85" class="outline-3">
<h3 id="orgd598a85"><span class="section-number-3">15.2</span> CSV</h3>
<div class="outline-text-3" id="text-15-2">
<p>
GNU Artanis integrated the third-party module <a href="https://github.com/NalaGinrut/guile-csv">guile-csv</a>. You may use #:mime method to handle CSV:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/csv"</span> <span style="color: #40e0d0;">#:mime</span> 'csv
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #40e0d0;">:mime</span> rc '((<span style="color: #ff0000;">"a"</span> <span style="color: #ff0000;">"1"</span>) (<span style="color: #ff0000;">"b"</span> <span style="color: #ff0000;">"2"</span>)))))
</pre>
</div>
</div>
</div>
<div id="outline-container-orged08e0b" class="outline-3">
<h3 id="orged08e0b"><span class="section-number-3">15.3</span> XML</h3>
<div class="outline-text-3" id="text-15-3">
<p>
In Scheme, XML is handled with SXML. Another way is to use strings appending method.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/xml"</span> <span style="color: #40e0d0;">#:mime</span> 'xml
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #40e0d0;">:mime</span> rc '(*TOP* (WEIGHT (@ (unit <span style="color: #ff0000;">"pound"</span>))
                                 (NET (@ (certified <span style="color: #ff0000;">"certified"</span>)) <span style="color: #ff0000;">"67"</span>)
                                 (GROSS <span style="color: #ff0000;">"95"</span>))))))
</pre>
</div>

<p>
The rendered result to the client will be:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #ffd700;">WEIGHT</span> <span style="color: #00ff00;">unit</span>=<span style="color: #ff0000;">"</span><span style="color: #ff0000;">pound</span><span style="color: #ff0000;">"</span>&gt;
  &lt;<span style="color: #ffd700;">NET</span> <span style="color: #00ff00;">certified</span>=<span style="color: #ff0000;">"</span><span style="color: #ff0000;">certified</span><span style="color: #ff0000;">"</span>&gt;67&lt;/<span style="color: #ffd700;">NET</span>&gt;
  &lt;<span style="color: #ffd700;">GROSS</span>&gt;95&lt;/<span style="color: #ffd700;">GROSS</span>&gt;
&lt;/<span style="color: #ffd700;">WEIGHT</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orge7112ad" class="outline-3">
<h3 id="orge7112ad"><span class="section-number-3">15.4</span> SXML</h3>
<div class="outline-text-3" id="text-15-4">
<p>
You can use SXML to replace XML for exchanging data format. This way saves some bandwidth.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/sxml"</span> <span style="color: #40e0d0;">#:mime</span> 'sxml
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #40e0d0;">:mime</span> rc '((a 1) (b 2)))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgbd49006" class="outline-2">
<h2 id="orgbd49006"><span class="section-number-2">16</span> Upload files</h2>
<div class="outline-text-2" id="text-16">
<p>
If you want to deal with uploading files, store-uploaded-files would be you friend.
</p>
</div>
<div id="outline-container-org24cd04c" class="outline-3">
<h3 id="org24cd04c"><span class="section-number-3">16.1</span> Receive upload from client</h3>
<div class="outline-text-3" id="text-16-1">
<div class="org-src-container">
<pre class="src src-scheme">(store-uploaded-files rc <span style="color: #40e0d0;">#:path</span> (current-upload-path)
                      <span style="color: #40e0d0;">#:uid</span> #f
                      <span style="color: #40e0d0;">#:gid</span> #f
                      <span style="color: #40e0d0;">#:simple-ret?</span> #t
                      <span style="color: #40e0d0;">#:mode</span> #o664
                      <span style="color: #40e0d0;">#:path-mode</span> #o775
                      <span style="color: #40e0d0;">#:sync</span> #f)
</pre>
</div>

<p>
<b>rc</b> is the route-context.
</p>

<p>
<code class="src src-scheme">#:path</code> is specified path to put uploaded files.
</p>

<p>
<code class="src src-scheme">#:uid</code> is new UID for uploaded files, #f means don't change the default UID.
</p>

<p>
<code class="src src-scheme">#:gid</code> specifies new GID.
</p>

<p>
<code class="src src-scheme">#:simple-ret?</code> specifies the mode of return:
</p>
<ul class="org-ul">
<li>if #t, there're only two possible return value, 'success for success, 'none for nothing has been done.</li>
<li>if #f, and while it's successful, it returns a list to show more details: (success size-list filename-list).</li>
</ul>

<p>
<code class="src src-scheme">#:mode</code> chmod files to mode.
</p>

<p>
<code class="src src-scheme">#:path-mode</code> chmod upload path to mode.
</p>

<p>
<code class="src src-scheme">#:sync</code> sync while storing files.
</p>
</div>
</div>
<div id="outline-container-orga3c4dee" class="outline-3">
<h3 id="orga3c4dee"><span class="section-number-3">16.2</span> Send upload to Server</h3>
<div class="outline-text-3" id="text-16-2">
<p>
Although GNU Artanis is often used in server-side, we provide this function for users to upload files from client.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(upload-files-to uri pattern)
</pre>
</div>

<p>
<b>uri</b> is standard HTTP URL:
</p>
<div class="org-src-container">
<pre class="src src-nil">scheme://[user:password@]domain:port/path?query_string#fragment_id
</pre>
</div>

<p>
<b>pattern</b> should be:  ((file filelist &#x2026;) (data datalist &#x2026;)), for example:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(upload-files-to <span style="color: #ff0000;">"ftp://nala:123@myupload.com/"</span>
                 '((data (<span style="color: #ff0000;">"data1"</span> <span style="color: #ff0000;">"hello world"</span>))
                   (file (<span style="color: #ff0000;">"file1"</span> <span style="color: #ff0000;">"filename"</span>) (<span style="color: #ff0000;">"file2"</span> <span style="color: #ff0000;">"filename2"</span>))))
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgabf6258" class="outline-2">
<h2 id="orgabf6258"><span class="section-number-2">17</span> Sessions</h2>
<div class="outline-text-2" id="text-17">
<p>
You have to use <code class="src src-scheme">#:session mode</code> while you defining URL rule handler.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(post <span style="color: #ff0000;">"/auth"</span> <span style="color: #40e0d0;">#:session</span> mode
      (<span style="color: #4169e1;">lambda</span> (rc) ...))
</pre>
</div>

<p>
<b>mode</b> could be:
</p>
<ul class="org-ul">
<li>#t or 'spawn, to spawn a new session, the name of SID is "sid" in default.</li>
<li>`(spawn ,sid) specify a name of sid to spawn.</li>
<li>`(spawn ,sid ,proc) specify a name of sid and a proc to <b>define your own session spawner</b>.</li>
</ul>

<p>
And the APIs of session is :session
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #40e0d0;">:session</span> rc cmd)
</pre>
</div>

<p>
<b>cmd</b> could be:
</p>
<ul class="org-ul">
<li>'check to check session with name "sid".</li>
<li>`(check ,sid) to check session with a specified sid name.</li>
<li>'check-and-spawn check "sid" first, if no, then spawn it.</li>
<li>`(check-and-spawn ,sid) the same with above, but specified name of sid.</li>
<li>`(check-and-spawn-and-keep ,sid) check then spawn then keep it, with the name of sid.</li>
<li>'spawn spawn a session with the name "sid".</li>
<li>'spawn-and-keep spawn a session then keep with the name "sid".</li>
</ul>
</div>
</div>
<div id="outline-container-org12f08a2" class="outline-2">
<h2 id="org12f08a2"><span class="section-number-2">18</span> Cookies</h2>
<div class="outline-text-2" id="text-18">
<p>
You have to use <code class="src src-scheme">#:cookies mode</code> while you defining URL rule handler.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/certain-rule"</span> <span style="color: #40e0d0;">#:cookies</span> mode
     (<span style="color: #4169e1;">lambda</span> (rc) ...))
</pre>
</div>

<p>
<b>mode</b> could be:
</p>
<ul class="org-ul">
<li>('names names &#x2026;) specifies the name list of the cookies.</li>
<li>('custom (names &#x2026;) maker setter getter modifier) specify a more complicated customized cookie handlers.</li>
</ul>

<p>
And the APIs:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #40e0d0;">:cookies-set!</span> rc cookie-name key val)

(<span style="color: #40e0d0;">:cookies-ref</span> rc cookie-name key)

(<span style="color: #40e0d0;">:cookies-setattr!</span> rc cookie-name <span style="color: #40e0d0;">#:expir</span> #f <span style="color: #40e0d0;">#:domain</span> #f
                   <span style="color: #40e0d0;">#:path</span> #f <span style="color: #40e0d0;">#:secure</span> #f <span style="color: #40e0d0;">#:http-only</span> #f)

(<span style="color: #40e0d0;">:cookies-remove!</span> rc key) <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">remove cookie from client</span>

(<span style="color: #40e0d0;">:cookies-update!</span> rc) <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">cookies operations won't work unless you update it</span>
</pre>
</div>

<p>
<b>NOTE</b>: You don't have to call <code class="src src-scheme">:cookies-update!</code> yourself, since it will be called automatically by the hook before the response.
</p>

<p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/cookie"</span> <span style="color: #40e0d0;">#:cookies</span> '(names cc)
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #40e0d0;">:cookies-set!</span> rc 'cc <span style="color: #ff0000;">"sid"</span> <span style="color: #ff0000;">"123321"</span>)
       <span style="color: #ff0000;">"ok"</span>))

(get <span style="color: #ff0000;">"/cookie/:expires"</span> <span style="color: #40e0d0;">#:cookies</span> '(names cc)
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #40e0d0;">:cookies-set!</span> rc 'cc <span style="color: #ff0000;">"sid"</span> <span style="color: #ff0000;">"123321"</span>)
       (<span style="color: #40e0d0;">:cookies-setattr!</span> rc 'cc <span style="color: #40e0d0;">#:expir</span> (string-&gt;number (params rc <span style="color: #ff0000;">"expires"</span>)))
       <span style="color: #ff0000;">"ok"</span>))
</pre>
</div>

<p>
Now you may use this command in the console to see the result:
</p>
<div class="org-src-container">
<pre class="src src-nil">curl --head localhost:3000/cookie
# and
curl --head localhost:3000/cookie/120
</pre>
</div>
</div>
</div>
<div id="outline-container-org1735623" class="outline-2">
<h2 id="org1735623"><span class="section-number-2">19</span> Authentication</h2>
<div class="outline-text-2" id="text-19">
</div><div id="outline-container-org764199b" class="outline-3">
<h3 id="org764199b"><span class="section-number-3">19.1</span> Init Authentication</h3>
<div class="outline-text-3" id="text-19-1">
<p>
GNU Artanis provides flexible mechanism for authentication.
</p>

<p>
You have to use <code class="src src-scheme">#:auth mode</code> while you defining URL rule handler.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/certain-rule"</span> <span style="color: #40e0d0;">#:auth</span> mode
     (<span style="color: #4169e1;">lambda</span> (rc) ...))
</pre>
</div>

<p>
<b>mode</b> could be:
</p>
<ul class="org-ul">
<li>SQL as <a href="#org9f72388">string template</a>. You may write your own customized SQL for fetching &amp; checking username and password.</li>
<li>('basic (lambda (rc user passwd) &#x2026;)) init a Basic Authentication mode. <i>user</i> is submitted username, <i>passwd</i> is submitted password value.</li>
<li>('table table-name username-field passwd-field) init a common Authentication mode. <b>The passwd will be encrypted by default algorithm</b>.</li>
<li>('table table-name username-field passwd-field crypto-proc) similar to the above item, but encrypt passwd with crypto-proc.</li>
<li>(table-name crypto-proc), so passwd field will be "passwd" and username will be "username" in default, and you may encrypt passwd with crypto-proc.</li>
</ul>

<p>
Available crypto-proc helper functions listed here:
</p>
<ul class="org-ul">
<li>(string-&gt;md5 str)</li>
<li>(string-&gt;sha-1 str)</li>
</ul>
</div>
</div>
<div id="outline-container-orgb745449" class="outline-3">
<h3 id="orgb745449"><span class="section-number-3">19.2</span> Basic Authentication</h3>
<div class="outline-text-3" id="text-19-2">
<p>
HTTP Basic authentication (BA) implementation is the simplest technique for enforcing access controls
to web resources because it doesn't require cookies, session identifier and login pages. Rather, HTTP
Basic authentication uses static, standard HTTP headers which means that no handshakes have to be done
in anticipation.
</p>

<p>
The BA mechanism provides no confidentiality protection for the transmitted credentials. They are merely
encoded with Base64 in transit, but not encrypted or hashed in any way. Basic Authentication is, therefore,
typically used over HTTPS.
</p>

<p>
<i><b>GNU Artanis doesn't support HTTPS at present, it is planned to support it in the future.</b></i>
</p>

<p>
Let's see a simple example:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">define</span> (<span style="color: #ffd700;">my-checker</span> rc user passwd)
  (<span style="color: #4169e1;">and</span> (string=? user <span style="color: #ff0000;">"jack"</span>) (string=? passwd <span style="color: #ff0000;">"123"</span>)))

(post <span style="color: #ff0000;">"/bauth"</span> <span style="color: #40e0d0;">#:auth</span> `(basic ,checker)
  (<span style="color: #4169e1;">lambda</span> (rc)
    (<span style="color: #4169e1;">if</span> (<span style="color: #40e0d0;">:auth</span> rc)
        <span style="color: #ff0000;">"auth ok"</span>
            (throw-auth-needed))))
</pre>
</div>

<p>
Another simple way is to compare the passsword stored in the database table:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(post <span style="color: #ff0000;">"/bauth"</span> <span style="color: #40e0d0;">#:auth</span> `(basic Person username passwd)
  (<span style="color: #4169e1;">lambda</span> (rc) ... ))
</pre>
</div>

<p>
NOTE: Assuming <b>username</b> and <b>passwd</b> is the fields of Person table. 
</p>


<p>
You have to define your own checker with the anonymous function <code class="src src-scheme">(lambda (rc u p) ...)</code>. #t for succeed, #f for failed.
</p>

<p>
APIs:
</p>

<ul class="org-ul">
<li><code class="src src-scheme">(:auth rc)</code> will check if Basic Authentication succeeded, #f for failed.</li>
<li><code class="src src-scheme">(throw-auth-needed)</code> is a useful helper function to ask for auth in client side.</li>
</ul>
</div>
</div>
<div id="outline-container-orgfa16f8c" class="outline-3">
<h3 id="orgfa16f8c"><span class="section-number-3">19.3</span> Common Authentication</h3>
<div class="outline-text-3" id="text-19-3">
<p>
Actually, there are multiple authentication methods that can be used by developers. Most of them are sort of tricky hacks. Here we only introduce the most common way.
</p>

<p>
The most common and relative safe way for authentication is to use POST method. And check username and passwd from a table in DB.
</p>

<p>
There're several syntax sugar for authentication.
</p>

<p>
The simplest case is for <a href="#org9f72388">String Template</a>:
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #40e0d0;">#:auth</span> <span style="color: #ff0000;">"string-template"</span>
</pre>
</div>

<p>
If you put the account information in a database table, then you may use table mode:
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #40e0d0;">#:auth</span> `(table ,table-name [,username-field] [,passwd-field] [,salt-field] [,hmac])
</pre>
</div>

<p>
NOTE: The square-bracked <b>[item]</b> is optional.
</p>

<p>
The default values of optional items are:
</p>
<ul class="org-ul">
<li>username-field: username</li>
<li>passwd-field: passwd</li>
<li>salt-field: salt</li>
</ul>

<p>
<b>GNU Artanis requires the salted password, it's not optional.</b>
</p>

<p>
So please prepare a field in the table for salt string. It's your duty to generate a
salt string, please see <a href="#org443e159">Random String Generator</a>. When authenticate, please specify the
salt field name in salt-field.
</p>

<p>
For hmac item, please see <a href="#org52acb7c">HMAC</a>.
</p>
</div>
</div>

<div id="outline-container-org2f5b3bf" class="outline-3">
<h3 id="org2f5b3bf"><span class="section-number-3">19.4</span> Login authentication</h3>
<div class="outline-text-3" id="text-19-4">
<p>
Usually, in login case, you need both <code class="src src-scheme">#:auth</code> and <code class="src src-scheme">#:session</code> for long time session.
The first step is to authenticate, if it's successful, then spawn a new session for this request. And the 
</p>

<p>
Here is a simple example:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(post <span style="color: #ff0000;">"/auth"</span> <span style="color: #40e0d0;">#:auth</span> '(table user <span style="color: #ff0000;">"user"</span> <span style="color: #ff0000;">"passwd"</span>) <span style="color: #40e0d0;">#:session</span> #t
      (<span style="color: #4169e1;">lambda</span> (rc)
        (<span style="color: #4169e1;">cond</span>
         ((<span style="color: #40e0d0;">:session</span> rc 'check) <span style="color: #ff0000;">"auth ok (session)"</span>)
         ((<span style="color: #40e0d0;">:auth</span> rc)
          (<span style="color: #40e0d0;">:session</span> rc 'spawn)
          <span style="color: #ff0000;">"auth ok"</span>)
         (<span style="color: #4169e1;">else</span> (redirect-to rc <span style="color: #ff0000;">"/login?login_failed=true"</span>)))))
</pre>
</div>

<p>
<b>NOTE: The passwd will be encrypted by default algorithm.</b>
</p>
</div>
</div>

<div id="outline-container-org52acb7c" class="outline-3">
<h3 id="org52acb7c"><span class="section-number-3">19.5</span> HMAC</h3>
<div class="outline-text-3" id="text-19-5">
<p>
<a href="https://en.wikipedia.org/wiki/HMAC">HMAC</a> is hash-based message authentication code.
Because it's very dangerous to store the passwd directly,
the safer way is to salt then hash with a strong cryptograpic hash function before store the passwd.
</p>

<p>
The default salt is a random string get from the operating system. And the default cryptographic hash function is SHA256.
You may customize your own HMAC function:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">define</span> (<span style="color: #ffd700;">my-hmac</span> passwd salt)
  (string-&gt;sha-512 (format #f <span style="color: #ff0000;">"~a-~a-~a"</span> passwd salt (current-time))))

(post <span style="color: #ff0000;">"/auth"</span> <span style="color: #40e0d0;">#:auth</span> `(table user <span style="color: #ff0000;">"user"</span> <span style="color: #ff0000;">"passwd"</span> <span style="color: #ff0000;">"salt"</span> ,my-hmac)
 ...... )
</pre>
</div>

<p>
The default HMAC function is:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">define</span> (<span style="color: #ffd700;">default-hmac</span> passwd salt)
  (string-&gt;sha-256 (string-append passwd salt)))
</pre>
</div>

<p>
For more hash functions, please see <a href="#orgf4f3048">Cryptographic hash functions</a>.
</p>
</div>
</div>
</div>
<div id="outline-container-org454de07" class="outline-2">
<h2 id="org454de07"><span class="section-number-2">20</span> Cache</h2>
<div class="outline-text-2" id="text-20">
</div><div id="outline-container-orgd15ebd1" class="outline-3">
<h3 id="orgd15ebd1"><span class="section-number-3">20.1</span> On web caching</h3>
<div class="outline-text-3" id="text-20-1">
<p>
Web caching is very important nowadays. This section discusses proper web
caching. It is not a full product guide document, but may help to understand how to
cache in GNU Artanis.
</p>

<p>
(to be continued&#x2026;)
</p>
</div>
</div>
<div id="outline-container-org1cf95c0" class="outline-3">
<h3 id="org1cf95c0"><span class="section-number-3">20.2</span> Cache APIs</h3>
<div class="outline-text-3" id="text-20-2">
<p>
You have to use <code class="src src-scheme">#:cache mode</code> while you defining URL rule handler.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/certain-rule"</span> <span style="color: #40e0d0;">#:cache</span> mode
     (<span style="color: #4169e1;">lambda</span> (rc) ...))
</pre>
</div>

<p>
<b><i>NOTE</i></b>: the default value of maxage is defined by <code class="src src-scheme">cache.maxage</code> in <code class="src src-scheme">/etc/artanis/artanis.conf</code>. The default value is 3600 seconds.
</p>

<p>
<b>mode</b> could be:
</p>
<ul class="org-ul">
<li><code class="src src-scheme">#t</code> for enabling caching the page.</li>
<li><code class="src src-scheme">#f</code> for disabling caching the page explicitly. It's default to not cache.</li>
<li><code class="src src-scheme">('static [maxage <- 3600])</code> This mode must be used for static files, which means the URL rule must be a real path to a static file.</li>
<li><code class="src src-scheme">(filename [maxage <- 3600])</code> Specify a static file to cache. This is useful when you don't want to reveal actual path of the static file, but use a fake URL for it.</li>
<li><code class="src src-scheme">('public filename [maxage <- 3600])</code> Allow proxies cache the content of specified static file. If HTTP authentication is required, responses are automatically set to private.</li>
<li><code class="src src-scheme">('private filename [maxage <- 3600])</code> Not-Allow proxies cache the content of specified static file.</li>
</ul>

<p>
Let's see the simplest cache test (for dynamic content):
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/new"</span> <span style="color: #40e0d0;">#:cache</span> #t
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #40e0d0;">:cache</span> rc <span style="color: #ff0000;">"hello world"</span>)))
</pre>
</div>

<p>
If you want to cache a static file, and permit proxies cache the content:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/hide"</span> <span style="color: #40e0d0;">#:cache</span> '(public <span style="color: #ff0000;">"pub/some.html"</span>)
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #40e0d0;">:cache</span> rc)))
</pre>
</div>

<p>
But, if your current URL rule is used for authentication (once you use <code class="src src-scheme">#:auth</code>), the cache will be changed to <b>private</b> even if you specify <b>public</b>.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get <span style="color: #ff0000;">"/pauth"</span>
  <span style="color: #40e0d0;">#:auth</span> `(basic ,(<span style="color: #4169e1;">lambda</span> (rc u p) (<span style="color: #4169e1;">and</span> (string=? u <span style="color: #ff0000;">"nala"</span>)
                                        (string=? p <span style="color: #ff0000;">"123"</span>))))
  <span style="color: #40e0d0;">#:cache</span> '(public <span style="color: #ff0000;">"pub/some.html"</span>) <span style="color: #66cdaa;">; </span><span style="color: #66cdaa;">will be changed to 'private' forcely.</span>
  (<span style="color: #4169e1;">lambda</span> (rc) (<span style="color: #40e0d0;">:cache</span> rc)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orga5e3d57" class="outline-2">
<h2 id="orga5e3d57"><span class="section-number-2">21</span> Shortcuts</h2>
<div class="outline-text-2" id="text-21">
</div><div id="outline-container-org882ead7" class="outline-3">
<h3 id="org882ead7"><span class="section-number-3">21.1</span> What is shortcuts?</h3>
<div class="outline-text-3" id="text-21-1">
<p>
The <i>shortcuts</i> is a series of special functions. It's used to simplify the complex
operations, according to the configuration specified by the related keyword, which
is set by you after a URL-rule.
</p>

<p>
It was named <i>OHT</i> which stands for <i>Optional Handler Table</i>, which indicate the basic
principle to be implemented, but too obscured to understand. So let's just call it <i>shortcut</i>.
</p>

<p>
Anyway, you may find them in the module <a href="https://gitlab.com/NalaGinrut/artanis/blob/master/artanis/oht.scm">(artanis oht)</a>.
</p>

<p>
It's a good practice to use <i>shortcuts</i> as possible and avoid calling low-level APIs.
</p>

<p>
Each shortcuts consists of 2 parts: <b>config</b> and <b>apply</b>.
</p>

<p>
<b>config</b> means you need to configure certain service for the specific URL rule. This configuration
will only be availble for this URL rule, and indenpendent to other registered URL rules.
</p>

<p>
<b>apply</b> is used for calling specific functions related to your configuration in <b>config</b> step. The
first argument of <b>apply</b> method must be <code class="src src-scheme">route-context</code> and it is
described in <a href="#org45c5efd">route context</a>.
</p>
</div>
</div>

<div id="outline-container-orgc9ac03c" class="outline-3">
<h3 id="orgc9ac03c"><span class="section-number-3">21.2</span> Database connection</h3>
<div class="outline-text-3" id="text-21-2">
<p>
This is useful when you use database. The shortcut provides a way to interact with the
raw connection. The connection is fetched from connection pool, which has been created
when GNU Artanis is started.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">config</span>
<span style="color: #40e0d0;">#:conn</span> #t

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">apply</span>
(<span style="color: #40e0d0;">:conn</span> <span style="color: #00ffff;">&lt;route-context&gt;</span> [sql])
</pre>
</div>

<ul class="org-ul">
<li>The second argument is optional, if it's missing, then <code class="src src-scheme">:conn</code>
will return the raw connection after applying <code class="src src-scheme">(:conn rc)</code>.
<ul class="org-ul">
<li>NOTE: If you didn't set <code class="src src-scheme">#:conn #t</code>, and applied
<code class="src src-scheme">(:conn rc)</code>, then <code class="src src-scheme">(rc-conn rc)</code>
will return <code class="src src-scheme">#f</code>. This is why you shouldn't use low-level
<code class="src src-scheme">(rc-conn rc)</code>.</li>
</ul></li>
<li>If the second argument exists, then it should be a valid SQL string for querying.
The returne value is described in <a href="#orgedc0190">DB connection pool</a>.
<ul class="org-ul">
<li>The SQL string could be generated from <a href="#org9b11454">SSQL</a>.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org8ebbf27" class="outline-3">
<h3 id="org8ebbf27"><span class="section-number-3">21.3</span> Raw SQL</h3>
<div class="outline-text-3" id="text-21-3">
<p>
This shortcut is useful for simple oneshot query.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">config</span>
<span style="color: #40e0d0;">#:raw-sql</span> sql

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">apply</span>
(<span style="color: #40e0d0;">:raw-sql</span> <span style="color: #00ffff;">&lt;route-context&gt;</span> mode)
</pre>
</div>

<p>
<b>Sql</b> must be a valid SQL string.
</p>

<p>
<b>Mode</b> is listed below:
</p>
<ul class="org-ul">
<li>'all for getting all the results.</li>
<li>'top for getting the first results.</li>
<li>A positive integer to indicate how many results should be returned.</li>
</ul>
</div>
</div>

<div id="outline-container-orgd07d7f6" class="outline-3">
<h3 id="orgd07d7f6"><span class="section-number-3">21.4</span> String template</h3>
<div class="outline-text-3" id="text-21-4">
<p>
The shortcut for <a href="#org9f72388">string template</a>. Sometimes it's useful when you just need a quick way to
use string template. But it doesn't support multi templates. If you do need multi templates
please use the traditional <a href="#org9f72388">24.1</a>.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">config</span>
<span style="color: #40e0d0;">#:str</span> <span style="color: #ff0000;">"string template"</span>

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">apply</span>
(<span style="color: #40e0d0;">:str</span> <span style="color: #00ffff;">&lt;route-context&gt;</span> key-values ...)
</pre>
</div>

<p>
Please checkout <a href="#org9f72388">string template</a> to find out how to use the <i>string-template</i> and <i>key-values</i>.
</p>
</div>
</div>

<div id="outline-container-org7e99e38" class="outline-3">
<h3 id="org7e99e38"><span class="section-number-3">21.5</span> SQL-Mapping shortcut (unfinished)</h3>
<div class="outline-text-3" id="text-21-5">
<p>
This is related to <a href="#org37320aa">SQL-Mapping</a>, which is still experimental, maybe you should wait for
the next version.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">config</span>
<span style="color: #40e0d0;">#:sql-mapping</span> config-patterns

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">apply</span>
(<span style="color: #40e0d0;">:sql-mapping</span> <span style="color: #00ffff;">&lt;route-context&gt;</span> command ...)
</pre>
</div>

<p>
Here're the <b>config-patterns</b>:
</p>
<ul class="org-ul">
<li><code class="src src-scheme">#t</code> enable the simple sql-mapping.</li>
<li><code class="src src-scheme">`(path ,path ,name)</code>
Fetch the sql-mapping with <i>name</i> in specified <i>path</i>.
<ul class="org-ul">
<li><i>name</i> should be in symbol type.</li>
<li><i>path</i> should be in string type, and an existing path in your filesystem.</li>
</ul></li>
<li><code class="src src-scheme">`(add ,name ,sql-template)</code>
Fetch the sql-mapping with <i>name</i> rendered from <i>sql-template</i>.
<ul class="org-ul">
<li><i>name</i> should be in symbol type.</li>
<li><i>sql-template</i> is decribed in <a href="#org37320aa">SQL-Mapping</a>.</li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org891885a" class="outline-2">
<h2 id="org891885a"><span class="section-number-2">22</span> Websocket (Experimental)</h2>
<div class="outline-text-2" id="text-22">
</div><div id="outline-container-org1ad2b21" class="outline-3">
<h3 id="org1ad2b21"><span class="section-number-3">22.1</span> Websocket introduction</h3>
<div class="outline-text-3" id="text-22-1">
<p>
Websocket is becoming more and more important for modern web development. GNU Artanis
is trying to provide an industrial strenth and efficient Websocket implementation.
Moreover, Websocket is important for the design of GNU Artanis, please see <a href="#org599132f">Principles</a> for more details.
</p>
</div>
</div>

<div id="outline-container-org6afccd0" class="outline-3">
<h3 id="org6afccd0"><span class="section-number-3">22.2</span> Websocket basic usage</h3>
<div class="outline-text-3" id="text-22-2">
<p>
<i>(The Websocket support is still experimental and unfinished, only demo works, please don't use it)</i>
</p>

<p>
In GNU Artanis, the Websocket handling is triggered by certain URL registered by you. You should
use <code class="src src-scheme">#:websocket</code> to configure the Websocket. For example:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">use-modules</span> (artanis artanis))

(get <span style="color: #ff0000;">"/echo"</span> <span style="color: #40e0d0;">#:websocket</span> '(proto echo)
     (<span style="color: #4169e1;">lambda</span> (rc)
       (<span style="color: #40e0d0;">:websocket</span> rc 'payload)))

(run <span style="color: #40e0d0;">#:port</span> 3000)
</pre>
</div>

<p>
In this simple test, we choose the simplest <b>echo</b> protocol of Websocket that return the string sent
from the client back.
And we write a simple JS for web frontend:
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #4169e1;">function</span> <span style="color: #ffd700;">WebSocketTest</span>()
{
    <span style="color: #4169e1;">if</span> (<span style="color: #ff0000;">"WebSocket"</span> <span style="color: #4169e1;">in</span> window)
    {
        document.write(<span style="color: #ff0000;">"&lt;p&gt;WebSocket is supported by your Browser!&lt;/p&gt;"</span>);

        <span style="color: #66cdaa;">// </span><span style="color: #66cdaa;">Let us open a web socket</span>
        <span style="color: #4169e1;">var</span> <span style="color: #00ff00;">ws</span> = <span style="color: #4169e1;">new</span> <span style="color: #00ffff;">WebSocket</span>(<span style="color: #ff0000;">"ws://localhost:3000/echo"</span>);

        ws.onopen = <span style="color: #4169e1;">function</span>()
        {
            <span style="color: #66cdaa;">// </span><span style="color: #66cdaa;">Web Socket is connected, send data using send()</span>
            ws.send(<span style="color: #ff0000;">"hello world"</span>);
            document.write(<span style="color: #ff0000;">"&lt;p&gt;Message is sent...&lt;/p&gt;"</span>);
        };

        ws.onmessage = <span style="color: #4169e1;">function</span> (<span style="color: #00ff00;">evt</span>)
        {
            <span style="color: #4169e1;">var</span> <span style="color: #00ff00;">received_msg</span> = evt.data;
            document.write(<span style="color: #ff0000;">"&lt;p&gt;hello welcome...&lt;/p&gt;"</span>);
        };

        ws.onclose = <span style="color: #4169e1;">function</span>()
        {
            <span style="color: #66cdaa;">// </span><span style="color: #66cdaa;">websocket is closed.</span>
            document.write(<span style="color: #ff0000;">"&lt;p&gt;Connection is closed...&lt;/p&gt;"</span>);
        };

        window.onbeforeunload = <span style="color: #4169e1;">function</span>(<span style="color: #00ff00;">event</span>) {
            socket.close();
        };
    }
    <span style="color: #4169e1;">else</span>
    {
        <span style="color: #66cdaa;">// </span><span style="color: #66cdaa;">The browser doesn't support WebSocket</span>
        document.write(<span style="color: #ff0000;">"&lt;p&gt;WebSocket NOT supported by your Browser!&lt;/p&gt;"</span>);
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org79eaaa6" class="outline-3">
<h3 id="org79eaaa6"><span class="section-number-3">22.3</span> Websocket APIs</h3>
<div class="outline-text-3" id="text-22-3">
<p>
<b>NOTE: The Websocket is very preliminary that only support echo. So it's not usable yet.</b>
</p>
</div>

<div id="outline-container-orga0b2ab4" class="outline-4">
<h4 id="orga0b2ab4"><span class="section-number-4">22.3.1</span> Websocket configuration</h4>
<div class="outline-text-4" id="text-22-3-1">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #40e0d0;">#:websocket</span> `(proto ,protocol_name)
</pre>
</div>
<p>
The <b>protocol_name</b> could be:
</p>
<ul class="org-ul">
<li><p>
<b>'echo</b> for simply echo test.
<b>NOTE:</b> More regular protocols will be added in the future.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #40e0d0;">#:websocket</span> simple_pattern
</pre>
</div>
<p>
The <b>simple_pattern</b> could be:
</p>
<ul class="org-ul">
<li><b>#t</b> or <b>'raw</b> means this URL enables Websocket without specifed protocol. So you will get raw
data of the decoded payload.</li>
</ul>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #40e0d0;">#:websocket</span> `(redirect ,ip/usk)
</pre>
</div>
<p>
This is used for redirecting Websocket stream to other address.
ip/usk means ip or unix-socket, the pattern should be this:
</p>
<ul class="org-ul">
<li><code class="src src-scheme">^ip://(?:[0-9]{1,3}\\.){3}[0-9]{1,3}(:[0-9]{1,5})?$</code></li>
<li><code class="src src-scheme">^unix://[a-zA-Z-_0-9]+\\.socket$</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #40e0d0;">#:websocket</span> `(proxy ,protocol)
</pre>
</div>
<p>
Setup a proxy with certain protocol handler.
Different from the regular proxy design, the proxy in Artanis doesn't
need a listen port, since it's always 80/443 or customized HTTP port.
The client should support websocket, and visit the related URL for establishing
a websocket channel. Then the rest is the same with regular proxy.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org15fbd65" class="outline-4">
<h4 id="org15fbd65"><span class="section-number-4">22.3.2</span> Websocket application</h4>
<div class="outline-text-4" id="text-22-3-2">
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #40e0d0;">:websocket</span> <span style="color: #00ffff;">&lt;route-context&gt;</span> command)
</pre>
</div>
<p>
The <b>command</b> could be:
</p>
<ul class="org-ul">
<li><b>'payload</b> to get the decoded data from the client. It's decoded from Websocket frame automatically.
So you don't have to parse the frame.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orged071d9" class="outline-3">
<h3 id="orged071d9"><span class="section-number-3">22.4</span> Websocket frame</h3>
<div class="outline-text-3" id="text-22-4">
<p>
According to <a href="https://tools.ietf.org/html/rfc6455">RFC6455</a>, GNU Artanis provides Websocket frame data
struct.
</p>

<p>
The frame will not be decoded or parsed into a record-type, on the contrary, it'll be kept as a binary
frame read from client, and use bitwise operations for fetching the fields. This kind of `lazy' design
will save much time on parsing unused fields each time, and eaiser for redirecting without any serialization.
If users want to get certain field, Artanis provides APIs for fetching them. Users can decide how to parse
the frames for efficiency.
</p>

<p>
Here're the APIs:
</p>

<div class="org-src-container">
<pre class="src src-scheme">(websocket-frame? <span style="color: #00ffff;">&lt;websocket-frame&gt;</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">parser: bytevector -&gt; customized data frame</span>
(websocket-frame-parser <span style="color: #00ffff;">&lt;websocket-frame&gt;</span>)
</pre>
</div>

<p>
<b>websocket-frame-parser</b> is the registered reader for the protocol specified by
<code class="src src-scheme">#:websocket</code> configuration. The protocol is customizable based on protobuf.
<i>NOTE: The customized protocol hasn't been implemented yet.</i>
</p>

<div class="org-src-container">
<pre class="src src-scheme">(websocket-frame-head <span style="color: #00ffff;">&lt;websocket-frame&gt;</span>)
(websocket-frame-final-fragment? <span style="color: #00ffff;">&lt;websocket-frame&gt;</span>)
(websocket-frame-opcode <span style="color: #00ffff;">&lt;websocket-frame&gt;</span>)
(websocket-frame-payload <span style="color: #00ffff;">&lt;websocket-frame&gt;</span>)
(websocket-frame-mask <span style="color: #00ffff;">&lt;websocket-frame&gt;</span>)
</pre>
</div>
<p>
Get the Websocket frame information, see <a href="https://tools.ietf.org/html/rfc6455#page-27">Data framing</a>.
</p>
<ul class="org-ul">
<li><b>head</b> is the first 2 bytes in the data frame.</li>
<li><b>final-fragment</b> means it's the last frame in a session.</li>
<li><b>opcode</b> is the opcode in the frame, see <a href="#org51564f2">Websocket opcode</a>.</li>
<li><b>payload</b> is the actual data which is encoded.</li>
<li><b>mask</b> is the mask of the frame.</li>
</ul>
</div>
</div>

<div id="outline-container-org51564f2" class="outline-3">
<h3 id="org51564f2"><span class="section-number-3">22.5</span> Websocket opcode</h3>
<div class="outline-text-3" id="text-22-5">
<p>
Defines the interpretation of the "Payload data". If an unknown opcode is received,
the receiving endpoint MUST fail the WebSocket connection.
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;;  </span><span style="color: #66cdaa;">check if it's a continuation frame</span>
(is-continue-frame? opcode)

<span style="color: #66cdaa;">;;  </span><span style="color: #66cdaa;">check if it's text frame</span>
(is-text-frame? opcode)

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">check if it's binary frame</span>
(is-binary-frame? opcode)

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">check if it's control frame</span>
(is-control-frame? opcode)
(is-non-control-frame? opcode)

<span style="color: #66cdaa;">;;  </span><span style="color: #66cdaa;">websocket requires closing</span>
(is-close-frame? opcode)

<span style="color: #66cdaa;">;;  </span><span style="color: #66cdaa;">check if it's a ping frame</span>
(is-ping-frame? opcode)

<span style="color: #66cdaa;">;;  </span><span style="color: #66cdaa;">check if it's a pong frame</span>
(is-pong-frame? opcode)

<span style="color: #66cdaa;">;;  </span><span style="color: #66cdaa;">%xB-F are reserved for further control frames</span>
(is-reserved-frame? opcode)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1db489b" class="outline-2">
<h2 id="org1db489b"><span class="section-number-2">23</span> Ragnarok server core</h2>
<div class="outline-text-2" id="text-23">
</div><div id="outline-container-orgdbe392e" class="outline-3">
<h3 id="orgdbe392e"><span class="section-number-3">23.1</span> Introduction</h3>
<div class="outline-text-3" id="text-23-1">
<p>
Since 0.2, GNU Artanis has a strong server core for high concurrency. It is named Ragnarok.
In the philosophy of the design of GNU Artanis, everything is meant to be flexible and customizable.
So the server core is customizable, in case someone thought Ragnarok is not good enough.
</p>

<p>
Ragnarok doesn't use any popular library for handling events (libev/libuv etc &#x2026;).
It's a brand new server core based on epoll and <a href="https://en.wikipedia.org/wiki/Delimited_continuation">delimited continuations</a>.
</p>
</div>
</div>

<div id="outline-container-org599132f" class="outline-3">
<h3 id="org599132f"><span class="section-number-3">23.2</span> Principles</h3>
<div class="outline-text-3" id="text-23-2">
<p>
The basic principle of Ragnarok is co-routine. And these co-routines are implemented with <a href="https://en.wikipedia.org/wiki/Delimited_continuation">delimited continuations</a>.
Actually, there's no OS-kernel controlled threads (say, pthread) for scheduling <i>request-handler</i> in Ragnarok.
All the tasks are scheduled by an userland scheduler, and the task is nothing but just a special continuation.
The key difference between it and regular <a href="https://en.wikipedia.org/wiki/Call-with-current-continuation#Criticism">full-stack continuation</a> is that it could be delimited for fine granularity
rather than capture the whole stack.
</p>

<p>
For reaserchers, there is a paper published on <a href="http://www.schemeworkshop.org/2016/">ICFP Scheme Workshop 2016 conference</a> to explain the principle and
the design of GNU Artanis:
</p>

<p>
<a href="https://github.com/NalaGinrut/artanis/raw/gh-pages/research/scheme16/art2016.pdf">Multi-purpose web framework design based on websockets over HTTP Gateway</a>.
</p>

<p>
(to be continued &#x2026;)
</p>
</div>
</div>

<div id="outline-container-orgedfa7c6" class="outline-3">
<h3 id="orgedfa7c6"><span class="section-number-3">23.3</span> Features</h3>
<div class="outline-text-3" id="text-23-3">
<p>
In Artanis, the request handling could be scheduled when the socket buffer is full (depends on <code class="src src-conf">server.bufsize</code>).
And let other request's handler run. Just like the scheduling of OS but it's in the userland.
</p>

<p>
So if it's the buffer issue when scheduling, then there's no way to flush before break since we can't tell if the
scheduling caused by buffering or blocking.
</p>

<p>
Ragnarok takes advantage of <code class="src src-conf">SO_REUSEPORT</code> introduced since GNU/Linux 3.9 to provde a feature
named <code class="src src-conf">server.multi</code> which could be enabled in config. This feature allows users to start several
Artanis instances which are all listenning on the same port to take advantage of multi cores. And the events are
dispatched by the Linux kernel.
</p>

<p>
(to be continued &#x2026;)
</p>
</div>
</div>

<div id="outline-container-orgcdf7a5b" class="outline-3">
<h3 id="orgcdf7a5b"><span class="section-number-3">23.4</span> Ragnarok APIs</h3>
<div class="outline-text-3" id="text-23-4">
<p>
You may use these APIs for customizing your own server core.
</p>

<p>
(to be continued &#x2026;)
</p>
</div>
</div>
</div>
<div id="outline-container-orgb1ef055" class="outline-2">
<h2 id="orgb1ef055"><span class="section-number-2">24</span> Utils</h2>
<div class="outline-text-2" id="text-24">
<p>
<b>The functions listed below requires to import <a href="https://gitlab.com/NalaGinrut/artanis/blob/master/artanis/utils.scm">(artanis utils)</a> module.</b>
</p>
</div>
<div id="outline-container-org9f72388" class="outline-3">
<h3 id="org9f72388"><span class="section-number-3">24.1</span> String Template</h3>
<div class="outline-text-3" id="text-24-1">
<p>
GNU Artanis provides Python3-like template strings:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(make-string-template tpl . vals)
</pre>
</div>

<ul class="org-ul">
<li><b>tpl</b> stands for template string.</li>
<li><b>vals</b> is varg-list specifying default value to certain key.</li>
</ul>

<p>
For an example:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(<span style="color: #4169e1;">define</span> <span style="color: #ffd700;">st</span> (make-string-template <span style="color: #ff0000;">"hello ${name}"</span>))
(st <span style="color: #40e0d0;">#:name</span> <span style="color: #ff0000;">"nala"</span>)
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">==&gt; "hello nala"</span>

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">or you may specify a default value for ${name}</span>
(<span style="color: #4169e1;">define</span> <span style="color: #ffd700;">st</span> (make-string-template <span style="color: #ff0000;">"hello ${name}"</span> <span style="color: #40e0d0;">#:name</span> <span style="color: #ff0000;">"unknown"</span>))
(st)
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">==&gt; "hello unknown"</span>
(st <span style="color: #40e0d0;">#:name</span> <span style="color: #ff0000;">"john"</span>)
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">==&gt; "hello john"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org443e159" class="outline-3">
<h3 id="org443e159"><span class="section-number-3">24.2</span> Random String Generator</h3>
<div class="outline-text-3" id="text-24-2">
<p>
Get random string from <code>/dev/urandom</code>.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get-random-from-dev <span style="color: #40e0d0;">#:length</span> 8 <span style="color: #40e0d0;">#:uppercase</span> #f)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf4f3048" class="outline-3">
<h3 id="orgf4f3048"><span class="section-number-3">24.3</span> Cryptographic hash functions</h3>
<div class="outline-text-3" id="text-24-3">
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">hash a string with MD5</span>
(string-&gt;md5 str)
<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">hash a string with SHA-1</span>
(string-&gt;sha-1 str)
</pre>
</div>

<p>
Since Artanis-0.2.5, we have SHA-2 hash functions:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(string-&gt;sha-224 str)
(string-&gt;sha-384 str)
(string-&gt;sha-512 str)
</pre>
</div>
</div>
</div>

<div id="outline-container-orga55b1ba" class="outline-3">
<h3 id="orga55b1ba"><span class="section-number-3">24.4</span> Stack &amp; Queue</h3>
<div class="outline-text-3" id="text-24-4">
<p>
GNU Artanis provides simple interfaces for stack &amp; queue:
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">stack operations</span>
(new-stack)
(stack-pop! stk)
(stack-push! stk elem)
(stack-top stk)
(stack-remove! stk key)
(stack-empty? stk)

<span style="color: #66cdaa;">;; </span><span style="color: #66cdaa;">queue operations</span>
(new-queue)
(queue-out! q)
(queue-in! q elem)
(queue-head q)
(queue-tail q)
(queue-remove! q key)
(queue-empty? q)
</pre>
</div>
</div>
</div>
<div id="outline-container-org17ce025" class="outline-3">
<h3 id="org17ce025"><span class="section-number-3">24.5</span> Useful string operation</h3>
<div class="outline-text-3" id="text-24-5">
<p>
If you want to get all contents in string from a file,
then don't use <code class="src src-conf">get-string-all</code> imported from rnrs. Because it
will not detect the correct charset from locale, and this may cause the length different
from the actual length. Although GNU Artanis can handle the length issue properly, you
should use <code class="src src-conf">get-string-all-with-detected-charset</code> once you need
to do the similar thing. If you don't care about the contents but just want to get the
contents anyway, it's better to use <code class="src src-conf">get-bytevector-all</code> imported
from rnrs.
</p>
<div class="org-src-container">
<pre class="src src-scheme">(get-string-all-with-detected-charset filename)
</pre>
</div>
</div>
</div>
<div id="outline-container-orga995ead" class="outline-3">
<h3 id="orga995ead"><span class="section-number-3">24.6</span> Time operation tool</h3>
<div class="outline-text-3" id="text-24-6">
<p>
TODO
</p>
</div>
</div>
</div>
<div id="outline-container-org455fc5a" class="outline-2">
<h2 id="org455fc5a"><span class="section-number-2">25</span> Debug mode</h2>
<div class="outline-text-2" id="text-25">
<p>
GNU Artanis provides debug-mode for more convenient debug. You may enable it easy.
</p>

<p>
For the simplest way, pass <code class="src src-scheme">#:debug #t</code> when calling <code class="src src-scheme">run</code> function:
</p>
<div class="org-src-container">
<pre class="src src-scheme">(run <span style="color: #40e0d0;">#:debug</span> #t)
</pre>
</div>

<p>
If you use MVC or created an app folder, just pass &#x2013;debug or -g:
</p>
<div class="org-src-container">
<pre class="src src-scheme"># In app folder
art work --debug
# Or
art work -g
</pre>
</div>

<p>
When you enabled debug-mode, the Model and Controller modules written by you will be reloaded automatically
on the fly.
</p>

<p>
If <b><i>not</i></b>, you have to press Ctrl+C to quit GNU Artanis server and start it again. This saves time.
</p>

<p>
And you may add paths to monitor certain files (for an instance, JSON as config file to be reloaded on the fly)
if you want to be notified when they're changed. Just put
the paths here:
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="color: #00ff00;">debug.monitor</span> = my/lib/json, my/lib/modules
</pre>
</div>
</div>
</div>


<div id="outline-container-orgec8aa3f" class="outline-2">
<h2 id="orgec8aa3f"><span class="section-number-2">26</span> Appendix A GNU Free Documentation License</h2>
<div class="outline-text-2" id="text-26">
<p>
Version 1.3, 3 November 2008
Copyright © 2000, 2001, 2002, 2007, 2008 Free Software Foundation, Inc.
<a href="http://fsf.org/">http://fsf.org/</a>
</p>

<p>
Everyone is permitted to copy and distribute verbatim copies
of this license document, but changing it is not allowed.
PREAMBLE
The purpose of this License is to make a manual, textbook, or other functional and useful document free in the sense of freedom: to assure everyone the effective freedom to copy and redistribute it, with or without modifying it, either commercially or noncommercially. Secondarily, this License preserves for the author and publisher a way to get credit for their work, while not being considered responsible for modifications made by others.
</p>

<p>
This License is a kind of “copyleft”, which means that derivative works of the document must themselves be free in the same sense. It complements the GNU General Public License, which is a copyleft license designed for free software.
</p>

<p>
We have designed this License in order to use it for manuals for free software, because free software needs free documentation: a free program should come with manuals providing the same freedoms that the software does. But this License is not limited to software manuals; it can be used for any textual work, regardless of subject matter or whether it is published as a printed book. We recommend this License principally for works whose purpose is instruction or reference.
</p>

<p>
APPLICABILITY AND DEFINITIONS
This License applies to any manual or other work, in any medium, that contains a notice placed by the copyright holder saying it can be distributed under the terms of this License. Such a notice grants a world-wide, royalty-free license, unlimited in duration, to use that work under the conditions stated herein. The “Document”, below, refers to any such manual or work. Any member of the public is a licensee, and is addressed as “you”. You accept the license if you copy, modify or distribute the work in a way requiring permission under copyright law.
</p>

<p>
A “Modified Version” of the Document means any work containing the Document or a portion of it, either copied verbatim, or with modifications and/or translated into another language.
</p>

<p>
A “Secondary Section” is a named appendix or a front-matter section of the Document that deals exclusively with the relationship of the publishers or authors of the Document to the Document’s overall subject (or to related matters) and contains nothing that could fall directly within that overall subject. (Thus, if the Document is in part a textbook of mathematics, a Secondary Section may not explain any mathematics.) The relationship could be a matter of historical connection with the subject or with related matters, or of legal, commercial, philosophical, ethical or political position regarding them.
</p>

<p>
The “Invariant Sections” are certain Secondary Sections whose titles are designated, as being those of Invariant Sections, in the notice that says that the Document is released under this License. If a section does not fit the above definition of Secondary then it is not allowed to be designated as Invariant. The Document may contain zero Invariant Sections. If the Document does not identify any Invariant Sections then there are none.
</p>

<p>
The “Cover Texts” are certain short passages of text that are listed, as Front-Cover Texts or Back-Cover Texts, in the notice that says that the Document is released under this License. A Front-Cover Text may be at most 5 words, and a Back-Cover Text may be at most 25 words.
</p>

<p>
A “Transparent” copy of the Document means a machine-readable copy, represented in a format whose specification is available to the general public, that is suitable for revising the document straightforwardly with generic text editors or (for images composed of pixels) generic paint programs or (for drawings) some widely available drawing editor, and that is suitable for input to text formatters or for automatic translation to a variety of formats suitable for input to text formatters. A copy made in an otherwise Transparent file format whose markup, or absence of markup, has been arranged to thwart or discourage subsequent modification by readers is not Transparent. An image format is not Transparent if used for any substantial amount of text. A copy that is not “Transparent” is called “Opaque”.
</p>

<p>
Examples of suitable formats for Transparent copies include plain ASCII without markup, Texinfo input format, LaTeX input format, SGML or XML using a publicly available DTD, and standard-conforming simple HTML, PostScript or PDF designed for human modification. Examples of transparent image formats include PNG, XCF and JPG. Opaque formats include proprietary formats that can be read and edited only by proprietary word processors, SGML or XML for which the DTD and/or processing tools are not generally available, and the machine-generated HTML, PostScript or PDF produced by some word processors for output purposes only.
</p>

<p>
The “Title Page” means, for a printed book, the title page itself, plus such following pages as are needed to hold, legibly, the material this License requires to appear in the title page. For works in formats which do not have any title page as such, “Title Page” means the text near the most prominent appearance of the work’s title, preceding the beginning of the body of the text.
</p>

<p>
The “publisher” means any person or entity that distributes copies of the Document to the public.
</p>

<p>
A section “Entitled XYZ” means a named subunit of the Document whose title either is precisely XYZ or contains XYZ in parentheses following text that translates XYZ in another language. (Here XYZ stands for a specific section name mentioned below, such as “Acknowledgements”, “Dedications”, “Endorsements”, or “History”.) To “Preserve the Title” of such a section when you modify the Document means that it remains a section “Entitled XYZ” according to this definition.
</p>

<p>
The Document may include Warranty Disclaimers next to the notice which states that this License applies to the Document. These Warranty Disclaimers are considered to be included by reference in this License, but only as regards disclaiming warranties: any other implication that these Warranty Disclaimers may have is void and has no effect on the meaning of this License.
</p>

<p>
VERBATIM COPYING
You may copy and distribute the Document in any medium, either commercially or noncommercially, provided that this License, the copyright notices, and the license notice saying this License applies to the Document are reproduced in all copies, and that you add no other conditions whatsoever to those of this License. You may not use technical measures to obstruct or control the reading or further copying of the copies you make or distribute. However, you may accept compensation in exchange for copies. If you distribute a large enough number of copies you must also follow the conditions in section 3.
</p>

<p>
You may also lend copies, under the same conditions stated above, and you may publicly display copies.
</p>

<p>
COPYING IN QUANTITY
If you publish printed copies (or copies in media that commonly have printed covers) of the Document, numbering more than 100, and the Document’s license notice requires Cover Texts, you must enclose the copies in covers that carry, clearly and legibly, all these Cover Texts: Front-Cover Texts on the front cover, and Back-Cover Texts on the back cover. Both covers must also clearly and legibly identify you as the publisher of these copies. The front cover must present the full title with all words of the title equally prominent and visible. You may add other material on the covers in addition. Copying with changes limited to the covers, as long as they preserve the title of the Document and satisfy these conditions, can be treated as verbatim copying in other respects.
</p>

<p>
If the required texts for either cover are too voluminous to fit legibly, you should put the first ones listed (as many as fit reasonably) on the actual cover, and continue the rest onto adjacent pages.
</p>

<p>
If you publish or distribute Opaque copies of the Document numbering more than 100, you must either include a machine-readable Transparent copy along with each Opaque copy, or state in or with each Opaque copy a computer-network location from which the general network-using public has access to download using public-standard network protocols a complete Transparent copy of the Document, free of added material. If you use the latter option, you must take reasonably prudent steps, when you begin distribution of Opaque copies in quantity, to ensure that this Transparent copy will remain thus accessible at the stated location until at least one year after the last time you distribute an Opaque copy (directly or through your agents or retailers) of that edition to the public.
</p>

<p>
It is requested, but not required, that you contact the authors of the Document well before redistributing any large number of copies, to give them a chance to provide you with an updated version of the Document.
</p>

<p>
MODIFICATIONS
You may copy and distribute a Modified Version of the Document under the conditions of sections 2 and 3 above, provided that you release the Modified Version under precisely this License, with the Modified Version filling the role of the Document, thus licensing distribution and modification of the Modified Version to whoever possesses a copy of it. In addition, you must do these things in the Modified Version:
</p>

<p>
Use in the Title Page (and on the covers, if any) a title distinct from that of the Document, and from those of previous versions (which should, if there were any, be listed in the History section of the Document). You may use the same title as a previous version if the original publisher of that version gives permission.
List on the Title Page, as authors, one or more persons or entities responsible for authorship of the modifications in the Modified Version, together with at least five of the principal authors of the Document (all of its principal authors, if it has fewer than five), unless they release you from this requirement.
State on the Title page the name of the publisher of the Modified Version, as the publisher.
Preserve all the copyright notices of the Document.
Add an appropriate copyright notice for your modifications adjacent to the other copyright notices.
Include, immediately after the copyright notices, a license notice giving the public permission to use the Modified Version under the terms of this License, in the form shown in the Addendum below.
Preserve in that license notice the full lists of Invariant Sections and required Cover Texts given in the Document’s license notice.
Include an unaltered copy of this License.
Preserve the section Entitled “History”, Preserve its Title, and add to it an item stating at least the title, year, new authors, and publisher of the Modified Version as given on the Title Page. If there is no section Entitled “History” in the Document, create one stating the title, year, authors, and publisher of the Document as given on its Title Page, then add an item describing the Modified Version as stated in the previous sentence.
Preserve the network location, if any, given in the Document for public access to a Transparent copy of the Document, and likewise the network locations given in the Document for previous versions it was based on. These may be placed in the “History” section. You may omit a network location for a work that was published at least four years before the Document itself, or if the original publisher of the version it refers to gives permission.
For any section Entitled “Acknowledgements” or “Dedications”, Preserve the Title of the section, and preserve in the section all the substance and tone of each of the contributor acknowledgements and/or dedications given therein.
Preserve all the Invariant Sections of the Document, unaltered in their text and in their titles. Section numbers or the equivalent are not considered part of the section titles.
Delete any section Entitled “Endorsements”. Such a section may not be included in the Modified Version.
Do not retitle any existing section to be Entitled “Endorsements” or to conflict in title with any Invariant Section.
Preserve any Warranty Disclaimers.
If the Modified Version includes new front-matter sections or appendices that qualify as Secondary Sections and contain no material copied from the Document, you may at your option designate some or all of these sections as invariant. To do this, add their titles to the list of Invariant Sections in the Modified Version’s license notice. These titles must be distinct from any other section titles.
</p>

<p>
You may add a section Entitled “Endorsements”, provided it contains nothing but endorsements of your Modified Version by various parties—for example, statements of peer review or that the text has been approved by an organization as the authoritative definition of a standard.
</p>

<p>
You may add a passage of up to five words as a Front-Cover Text, and a passage of up to 25 words as a Back-Cover Text, to the end of the list of Cover Texts in the Modified Version. Only one passage of Front-Cover Text and one of Back-Cover Text may be added by (or through arrangements made by) any one entity. If the Document already includes a cover text for the same cover, previously added by you or by arrangement made by the same entity you are acting on behalf of, you may not add another; but you may replace the old one, on explicit permission from the previous publisher that added the old one.
</p>

<p>
The author(s) and publisher(s) of the Document do not by this License give permission to use their names for publicity for or to assert or imply endorsement of any Modified Version.
</p>

<p>
COMBINING DOCUMENTS
You may combine the Document with other documents released under this License, under the terms defined in section 4 above for modified versions, provided that you include in the combination all of the Invariant Sections of all of the original documents, unmodified, and list them all as Invariant Sections of your combined work in its license notice, and that you preserve all their Warranty Disclaimers.
</p>

<p>
The combined work need only contain one copy of this License, and multiple identical Invariant Sections may be replaced with a single copy. If there are multiple Invariant Sections with the same name but different contents, make the title of each such section unique by adding at the end of it, in parentheses, the name of the original author or publisher of that section if known, or else a unique number. Make the same adjustment to the section titles in the list of Invariant Sections in the license notice of the combined work.
</p>

<p>
In the combination, you must combine any sections Entitled “History” in the various original documents, forming one section Entitled “History”; likewise combine any sections Entitled “Acknowledgements”, and any sections Entitled “Dedications”. You must delete all sections Entitled “Endorsements.”
</p>

<p>
COLLECTIONS OF DOCUMENTS
You may make a collection consisting of the Document and other documents released under this License, and replace the individual copies of this License in the various documents with a single copy that is included in the collection, provided that you follow the rules of this License for verbatim copying of each of the documents in all other respects.
</p>

<p>
You may extract a single document from such a collection, and distribute it individually under this License, provided you insert a copy of this License into the extracted document, and follow this License in all other respects regarding verbatim copying of that document.
</p>

<p>
AGGREGATION WITH INDEPENDENT WORKS
A compilation of the Document or its derivatives with other separate and independent documents or works, in or on a volume of a storage or distribution medium, is called an “aggregate” if the copyright resulting from the compilation is not used to limit the legal rights of the compilation’s users beyond what the individual works permit. When the Document is included in an aggregate, this License does not apply to the other works in the aggregate which are not themselves derivative works of the Document.
</p>

<p>
If the Cover Text requirement of section 3 is applicable to these copies of the Document, then if the Document is less than one half of the entire aggregate, the Document’s Cover Texts may be placed on covers that bracket the Document within the aggregate, or the electronic equivalent of covers if the Document is in electronic form. Otherwise they must appear on printed covers that bracket the whole aggregate.
</p>

<p>
TRANSLATION
Translation is considered a kind of modification, so you may distribute translations of the Document under the terms of section 4. Replacing Invariant Sections with translations requires special permission from their copyright holders, but you may include translations of some or all Invariant Sections in addition to the original versions of these Invariant Sections. You may include a translation of this License, and all the license notices in the Document, and any Warranty Disclaimers, provided that you also include the original English version of this License and the original versions of those notices and disclaimers. In case of a disagreement between the translation and the original version of this License or a notice or disclaimer, the original version will prevail.
</p>

<p>
If a section in the Document is Entitled “Acknowledgements”, “Dedications”, or “History”, the requirement (section 4) to Preserve its Title (section 1) will typically require changing the actual title.
</p>

<p>
TERMINATION
You may not copy, modify, sublicense, or distribute the Document except as expressly provided under this License. Any attempt otherwise to copy, modify, sublicense, or distribute it is void, and will automatically terminate your rights under this License.
</p>

<p>
However, if you cease all violation of this License, then your license from a particular copyright holder is reinstated (a) provisionally, unless and until the copyright holder explicitly and finally terminates your license, and (b) permanently, if the copyright holder fails to notify you of the violation by some reasonable means prior to 60 days after the cessation.
</p>

<p>
Moreover, your license from a particular copyright holder is reinstated permanently if the copyright holder notifies you of the violation by some reasonable means, this is the first time you have received notice of violation of this License (for any work) from that copyright holder, and you cure the violation prior to 30 days after your receipt of the notice.
</p>

<p>
Termination of your rights under this section does not terminate the licenses of parties who have received copies or rights from you under this License. If your rights have been terminated and not permanently reinstated, receipt of a copy of some or all of the same material does not give you any rights to use it.
</p>

<p>
FUTURE REVISIONS OF THIS LICENSE
The Free Software Foundation may publish new, revised versions of the GNU Free Documentation License from time to time. Such new versions will be similar in spirit to the present version, but may differ in detail to address new problems or concerns. See <a href="http://www.gnu.org/copyleft/">http://www.gnu.org/copyleft/</a>.
</p>

<p>
Each version of the License is given a distinguishing version number. If the Document specifies that a particular numbered version of this License “or any later version” applies to it, you have the option of following the terms and conditions either of that specified version or of any later version that has been published (not as a draft) by the Free Software Foundation. If the Document does not specify a version number of this License, you may choose any version ever published (not as a draft) by the Free Software Foundation. If the Document specifies that a proxy can decide which future versions of this License can be used, that proxy’s public statement of acceptance of a version permanently authorizes you to choose that version for the Document.
</p>

<p>
RELICENSING
“Massive Multiauthor Collaboration Site” (or “MMC Site”) means any World Wide Web server that publishes copyrightable works and also provides prominent facilities for anybody to edit those works. A public wiki that anybody can edit is an example of such a server. A “Massive Multiauthor Collaboration” (or “MMC”) contained in the site means any set of copyrightable works thus published on the MMC site.
</p>

<p>
“CC-BY-SA” means the Creative Commons Attribution-Share Alike 3.0 license published by Creative Commons Corporation, a not-for-profit corporation with a principal place of business in San Francisco, California, as well as future copyleft versions of that license published by that same organization.
</p>

<p>
“Incorporate” means to publish or republish a Document, in whole or in part, as part of another Document.
</p>

<p>
An MMC is “eligible for relicensing” if it is licensed under this License, and if all works that were first published under this License somewhere other than this MMC, and subsequently incorporated in whole or in part into the MMC, (1) had no cover texts or invariant sections, and (2) were thus incorporated prior to November 1, 2008.
</p>

<p>
The operator of an MMC Site may republish an MMC contained in the site under CC-BY-SA on the same site at any time before August 1, 2009, provided the MMC is eligible for relicensing.
</p>

<p>
ADDENDUM: How to use this License for your documents
</p>

<p>
To use this License in a document you have written, include a copy of the License in the document and put the following copyright and license notices just after the title page:
</p>

<p>
Copyright (C)  year  your name.
Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover
Texts.  A copy of the license is included in the section entitled ``GNU
Free Documentation License''.
If you have Invariant Sections, Front-Cover Texts and Back-Cover Texts, replace the “with…Texts.” line with this:
</p>

<p>
with the Invariant Sections being list their titles, with
the Front-Cover Texts being list, and with the Back-Cover Texts
being list.
If you have Invariant Sections without Cover Texts, or some other combination of the three, merge those two alternatives to suit the situation.
</p>

<p>
If your document contains nontrivial examples of program code, we recommend releasing these examples in parallel under your choice of free software license, such as the GNU General Public License, to permit their use in free software.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Mu Lei known as NalaGinrut</p>
<p class="date">Created: 2018-05-08 Tue 01:51</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
